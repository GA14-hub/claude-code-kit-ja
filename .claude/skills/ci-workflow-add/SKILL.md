---
name: ci-workflow-add
description: GitHub Actions ワークフローのテンプレートを生成する。プロジェクトの言語・構成を自動検出し最適な CI を構築する。
argument-hint: "[node|python|go|auto] (任意でワークフロー種別: ci/cd/release)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

プロジェクトの言語・パッケージマネージャ・ディレクトリ構成を自動検出し、GitHub Actions のワークフローファイル（`.github/workflows/*.yml`）を生成する。キャッシュ戦略・並列実行・セキュリティのベストプラクティスを組み込んだ、実運用可能なテンプレートを提供する。

## 入力

- 対象言語またはランタイム（node / python / go / auto）（必須）
- 任意: ワークフロー種別（ci / cd / release）
- 任意: 対象ブランチやトリガー条件の指定
- 任意: 特定のテストフレームワークやビルドツールの指定
- 不足している場合はユーザーに質問する

## 手順

1. **プロジェクト構成の自動検出**
   - Glob でプロジェクトルートの設定ファイルを検索する（`package.json`、`pyproject.toml`、`go.mod` など）
   - 検出したファイルを Read で読み取り、言語バージョン・依存管理ツール・テストコマンドを特定する
   - `.github/workflows/` ディレクトリの有無を確認し、既存ワークフローがある場合は Read で内容を把握する
   - `git log --oneline -10` でブランチ戦略（main/develop/feature 等）を推定する

2. **ワークフロー要件の整理**
   - 検出結果をもとに以下を決定する:
     - トリガー条件（push / pull_request / schedule / workflow_dispatch）
     - 実行環境（ubuntu-latest / windows-latest / macos-latest）
     - 必要なジョブ（lint、test、build、deploy 等）
     - キャッシュ対象（node_modules、pip cache、Go module cache）
     - 環境変数・シークレットの要否

3. **ワークフローファイルの設計**
   - ジョブ間の依存関係を整理し、並列実行可能なジョブを特定する
   - キャッシュキーの戦略を設計する（ハッシュ対象ファイル、フォールバックキー）
   - タイムアウト値、リトライ戦略、失敗時の通知を設定する
   - パーミッション設定を最小権限の原則に基づいて記述する

4. **テンプレートの生成**
   - YAML 形式でワークフローファイルの全文を生成する
   - 各ステップにコメントで意図を記述する
   - プロジェクト固有の値（バージョン、パス、コマンド）は検出結果を反映する
   - actions/checkout、actions/setup-node 等の公式アクションは最新安定バージョンを指定する

5. **セキュリティとベストプラクティスの検証**
   - `permissions` ブロックで最小権限を設定しているか確認する
   - サードパーティアクションはコミットハッシュでピン留めしているか確認する
   - シークレットの参照方法が安全か確認する
   - Dependabot 用の設定が必要か検討する

## 出力フォーマット

```markdown
## プロジェクト検出結果

- **言語/ランタイム**: [検出された言語とバージョン]
- **パッケージマネージャ**: [npm/yarn/pnpm/pip/poetry/go mod]
- **テストコマンド**: [検出されたテスト実行コマンド]
- **ビルドコマンド**: [検出されたビルドコマンド]
- **既存ワークフロー**: [あり/なし（ありの場合はファイル名）]

## ワークフロー設計

- **トリガー**: [push/PR/schedule の条件]
- **ジョブ構成**: [ジョブ名と依存関係の概要]
- **キャッシュ戦略**: [キャッシュ対象と復元キー]
- **推定実行時間**: [目安の実行時間]

## 生成ファイル

### `.github/workflows/ci.yml`

[YAML 全文をコードブロックで出力]

## セキュリティチェック

- [ ] permissions が最小権限で設定されている
- [ ] サードパーティアクションがハッシュでピン留めされている
- [ ] シークレット参照が安全な方法で行われている
- [ ] pull_request_target ではなく pull_request を使用している

## 導入手順

1. [ファイル配置の手順]
2. [必要なシークレットの設定手順]
3. [初回実行時の確認事項]
```

## 安全注意

- 生成するワークフローにシークレットの値そのものを含めない（`${{ secrets.XXX }}` の参照のみ）
- `pull_request_target` トリガーは外部 PR からのコード実行リスクがあるため、原則使用しない
- `permissions` を省略せず、必要最小限の権限を明示する
- 既存の `.github/workflows/` ファイルを上書きする場合はユーザーに確認を求める
- ファイルの作成・変更は行わず、テンプレートの出力のみ行う

## 終了条件

上記の出力フォーマットに従ったワークフローテンプレートを出力したら停止する。プロジェクト検出結果、YAML 全文、セキュリティチェックリスト、導入手順が含まれていること。ファイルの配置はユーザーの指示を待つ。
