---
name: api-auth-review
description: APIの認可設計をレビューし、権限チェック漏れ・スコープ設計の不備を検出する。アクセス制御の安全性を検証する。
argument-hint: "[APIコードベース|ルーティング定義|認可設定ファイル] (任意で重点エンドポイント)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

API の認可（Authorization）設計を体系的にレビューし、権限チェック漏れ・スコープ設計の不備・権限昇格リスクを検出する。各エンドポイントに適切なアクセス制御が設定されているかを検証し、OWASP API Security Top 10 の「Broken Object Level Authorization（BOLA）」「Broken Function Level Authorization」等の脆弱性リスクを洗い出す。安全で一貫性のある認可アーキテクチャを提案する。

## 入力

- API コードベースのディレクトリパスまたは認可関連ファイル（必須）
- ルーティング定義ファイル（任意）
- 認可設定・ポリシーファイル（任意）
- ユーザーロール・権限の定義（任意）
- 重点的にレビューしたいエンドポイント（任意）
- 不足している場合はユーザーに質問する

## 手順

1. **認可アーキテクチャの把握**
   - Glob で認可関連ファイル（`middleware/auth*`、`guard*`、`policy*`、`permission*`、`rbac*` 等）を検索する
   - 認可方式を特定する: RBAC（ロールベース）、ABAC（属性ベース）、ACL、OAuth スコープ等
   - 認可チェックの実装パターン（ミドルウェア、デコレーター、ガード、インターセプター等）を把握する
   - ロール定義・権限定義の一覧を Read で確認する
   - 認可判定のロジック（許可リスト方式 vs 拒否リスト方式）を確認する

2. **エンドポイント別認可マッピングの作成**
   - すべてのエンドポイントを列挙する（ルーティング定義を Grep/Read で収集）
   - 各エンドポイントに設定されている認可チェック（ロール、スコープ、ポリシー）を特定する
   - 認可チェックが設定されていないエンドポイントを「未保護」として検出する
   - 管理者向けエンドポイントと一般ユーザー向けエンドポイントの区別を確認する
   - 公開エンドポイント（認証不要）が意図的なものか確認する

3. **オブジェクトレベル認可（BOLA）の検証**
   - リソースの CRUD 操作で、リクエスト者がそのリソースの所有者/アクセス権者であることを検証しているか確認する
   - パスパラメータやクエリパラメータで指定される ID に対して、所有権チェックが行われているか検索する
   - 他のユーザーのリソースに対する不正アクセスが可能なパターンを検出する:
     - `GET /users/{id}/data` で任意の `id` を指定できる問題
     - `PUT /orders/{id}` で他者の注文を更新できる問題
   - IDOR（Insecure Direct Object Reference）パターンの有無を確認する

4. **機能レベル認可の検証**
   - 管理者向け機能（ユーザー管理、設定変更、データエクスポート等）に適切な権限チェックがあるか確認する
   - HTTP メソッドによる権限分離を確認する（GET は許可、DELETE は制限 等）
   - 一般ユーザー向けエンドポイントから管理者機能へのエスカレーションパスがないか検証する
   - バッチ操作・一括処理エンドポイントの権限設計を確認する
   - 内部向け API と外部向け API のアクセス制御分離を確認する

5. **スコープ設計の評価**
   - OAuth スコープまたは API キー権限の粒度が適切か評価する
   - 過剰な権限付与（broad scope）のパターンを検出する
   - 最小権限の原則（Principle of Least Privilege）に準拠しているか確認する
   - スコープの階層構造と継承関係が適切か確認する
   - トークンのスコープとエンドポイントの権限要件の整合性を検証する

6. **認可設計の改善提案**
   - 検出した問題点を重要度別に整理する
   - 認可アーキテクチャの改善案を提示する
   - 欠落しているスコープ・権限の定義を提案する
   - 認可テストの追加が必要な箇所を特定する

## 出力フォーマット

```markdown
## API 認可レビューレポート

### 認可アーキテクチャ概要
- **認可方式**: [RBAC/ABAC/ACL/OAuth スコープ/その他]
- **実装パターン**: [ミドルウェア/デコレーター/ガード]
- **ロール定義**: [検出されたロール一覧]
- **スコープ定義**: [検出されたスコープ一覧]
- **判定方式**: [許可リスト/拒否リスト]

### エンドポイント認可マッピング

| エンドポイント | メソッド | 認証 | 認可チェック | 所有権チェック | 状態 |
|--------------|---------|------|------------|--------------|------|
| /users | GET | 必要 | admin ロール | - | OK |
| /users/{id} | GET | 必要 | なし | なし | 要対応 |
| /admin/config | PUT | 必要 | なし | - | 危険 |
| /public/info | GET | 不要 | - | - | 意図的 |

### 検出された問題

#### CRITICAL: 認可チェック漏れ

| # | エンドポイント | 問題 | リスク | ファイル |
|---|--------------|------|-------|---------|
| 1 | [パス] | [問題の詳細] | [リスクの説明] | [ファイル:行] |

#### HIGH: オブジェクトレベル認可（BOLA）の不備

| # | エンドポイント | 問題 | 攻撃シナリオ | ファイル |
|---|--------------|------|-------------|---------|
| 1 | [パス] | [問題の詳細] | [攻撃の例] | [ファイル:行] |

#### MEDIUM: スコープ設計の問題

| # | スコープ | 問題 | 改善案 |
|---|---------|------|-------|
| 1 | [スコープ名] | [問題の詳細] | [改善の方向性] |

#### LOW: 改善推奨事項

| # | 対象 | 推奨事項 | 理由 |
|---|------|---------|------|
| 1 | [対象] | [推奨事項] | [理由] |

### 統計サマリ

| 重要度 | 件数 |
|--------|------|
| Critical | X件 |
| High | X件 |
| Medium | X件 |
| Low | X件 |
| 保護済みエンドポイント | X / Y（全体） |
| 未保護エンドポイント | X件 |

### スコープ設計改善案

| 現状のスコープ | 推奨するスコープ分割 | 理由 |
|--------------|-------------------|------|
| [broad_scope] | [read:resource, write:resource] | [最小権限の原則] |

### 推奨する認可テスト

- [ ] [テストケース1: 未認証ユーザーが保護エンドポイントにアクセスできないこと]
- [ ] [テストケース2: 一般ユーザーが管理者エンドポイントにアクセスできないこと]
- [ ] [テストケース3: ユーザーAがユーザーBのリソースにアクセスできないこと]

### 次のアクション

1. **最優先**: [Critical の問題への対処]
2. **短期**: [High の問題への対処]
3. **中期**: [スコープ再設計]
```

## 安全注意

- 認可ロジックの読み取りと分析のみを行い、認可設定の変更は実施しない
- テスト用であっても、実際の認証トークンやシークレットを生成・使用しない
- 発見した脆弱性の具体的な攻撃手法はレポートに詳細に記載しない（リスクの概要のみ）
- 本番環境のエンドポイントに対する認可テストリクエストは実行しない
- 権限設定ファイルにハードコードされた認証情報が含まれている場合はマスクして報告する
- 認可チェック漏れが Critical として検出された場合はユーザーに即座に警告する

## 終了条件

上記の出力フォーマットに従った認可レビューレポートを出力したら停止する。すべてのエンドポイントの認可状況がマッピングされ、問題が重要度別に分類・記載されていること。修正作業はユーザーの指示を待つ。
