---
name: postmortem-write
description: インシデントのポストモーテムを作成する。タイムライン・根本原因・再発防止策をテンプレートに沿って整理し、防止タスクを生成する。
argument-hint: "[インシデント概要 or 関連コミット範囲] (任意で障害発生日時)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git log *), Bash(git diff *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

インシデント（障害・事故）のポストモーテム（事後分析）文書を作成する。blame-free（個人を責めない）の原則に基づき、事実ベースのタイムライン、根本原因分析（RCA）、再発防止策を体系的に整理する。再発防止策は具体的なタスクとして起票可能な粒度まで分解する。

## 入力

- インシデントの概要（何が起きたか）（必須）
- 任意: 関連するコミット範囲やデプロイ日時
- 任意: 障害発生日時と復旧日時
- 任意: 影響を受けたユーザー数や機能範囲
- 任意: 既に判明している原因や対応内容
- 不足している場合はユーザーに質問する

## 手順

1. **事実の収集**
   - `git log --oneline --since="[障害前日]" --until="[障害後日]"` で関連期間のコミットを確認する
   - `git diff [障害前のコミット]...[障害後のコミット]` で変更内容を確認する
   - Grep でエラーハンドリング、設定変更、依存関係の変更に関するコードを検索する
   - Read で関連するコードファイルの内容を確認する

2. **タイムラインの構築**
   - 障害に至るまでのイベントを時系列で整理する:
     - コード変更 → デプロイ → 最初の異常検知 → エスカレーション → 対応開始 → 復旧
   - 各イベントの時刻を可能な限り正確に記録する
   - 検知から対応開始までの時間（TTD）、対応開始から復旧までの時間（TTR）を算出する

3. **根本原因分析（RCA）**
   - 5 Whys 手法で根本原因を掘り下げる
   - 直接原因（技術的な原因）と寄与要因（プロセス・組織的な要因）を分離する
   - 「なぜ事前に防げなかったか」「なぜ検知が遅れたか」も分析対象とする

4. **影響範囲の評価**
   - 影響を受けたユーザー数・リクエスト数を推定する
   - 機能停止の範囲（全面停止 / 部分停止 / 性能劣化）を記録する
   - ビジネスへの影響（売上損失、SLA 違反 等）があれば記録する

5. **再発防止策の策定**
   - 再発防止策を以下の 3 カテゴリに分類する:
     - **即時対応（1 週間以内）**: 暫定的な修正、監視強化
     - **短期対応（1 ヶ月以内）**: 根本的な修正、テスト追加
     - **長期対応（四半期内）**: プロセス改善、アーキテクチャ改善
   - 各防止策をタスク起票可能な粒度に分解する（担当・期限の欄を用意）

## 出力フォーマット

```markdown
## ポストモーテム: [インシデントタイトル]

**作成日**: [日付]
**深刻度**: P1 / P2 / P3
**ステータス**: ドラフト

## サマリ

[3〜5 行でインシデントの概要を記述]

## 影響

- **期間**: [発生時刻] 〜 [復旧時刻]（合計 [N] 時間 [M] 分）
- **影響範囲**: [影響を受けた機能・サービス]
- **影響ユーザー数**: [推定値]
- **TTD（検知時間）**: [N 分]
- **TTR（復旧時間）**: [N 分]

## タイムライン

| 時刻 | イベント | 実行者/システム |
|------|---------|---------------|
| [HH:MM] | [イベント内容] | [人/システム名] |

## 根本原因分析

### 直接原因
[技術的な直接原因の説明]

### 5 Whys
1. なぜ [現象] が発生したか？ → [回答]
2. なぜ [回答1] が起きたか？ → [回答]
3. なぜ [回答2] が起きたか？ → [回答]
4. なぜ [回答3] が起きたか？ → [回答]
5. なぜ [回答4] が起きたか？ → [根本原因]

### 寄与要因
- [プロセス面の寄与要因]
- [組織面の寄与要因]

## 教訓（Lessons Learned）

### うまくいったこと
- [良かった点]

### 改善が必要なこと
- [改善すべき点]

## 再発防止タスク

### 即時対応（1 週間以内）

| # | タスク | 担当 | 期限 | ステータス |
|---|--------|------|------|----------|
| 1 | [タスク内容] | [未定] | [日付] | 未着手 |

### 短期対応（1 ヶ月以内）

| # | タスク | 担当 | 期限 | ステータス |
|---|--------|------|------|----------|
| 1 | [タスク内容] | [未定] | [日付] | 未着手 |

### 長期対応（四半期内）

| # | タスク | 担当 | 期限 | ステータス |
|---|--------|------|------|----------|
| 1 | [タスク内容] | [未定] | [日付] | 未着手 |
```

## 安全注意

- blame-free の原則を厳守する：個人名を原因として記述しない
- タイムラインには事実のみを記載し、推測や感情的な表現を含めない
- 機密情報（顧客データ、内部 URL、認証情報）をポストモーテム文書に含めない
- git diff の結果にシークレットが含まれる場合は該当部分をマスクする
- 根本原因は技術的・プロセス的な問題として記述し、個人の責任に帰結させない

## 終了条件

上記の出力フォーマットに従ったポストモーテム文書を出力したら停止する。サマリ、タイムライン、根本原因分析、再発防止タスク（担当・期限欄つき）が含まれていること。文書のレビューと再発防止タスクの起票はユーザーの指示を待つ。
