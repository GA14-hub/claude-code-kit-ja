---
name: incident-debug
description: 本番障害の総合調査フロー。ログ・コード・履歴を横断して原因を特定する。
argument-hint: "[error-log|symptom-description|url] (任意で発生時刻・環境)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git *)
context: fork
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

本番障害またはクリティカルなバグに対して、ログ・コード・git 履歴を横断的に調査し、根本原因の特定と復旧手順を提示する。

## 入力

- エラーログ、障害の症状、またはエラーが発生した URL（必須）
- 発生時刻（任意: タイムラインの絞り込みに使用）
- 環境情報（任意: 本番/ステージング、OS、バージョン等）
- 不足している場合はユーザーに質問する

## 手順

1. **症状の整理**: 報告された障害の症状・影響範囲・発生条件を整理する
2. **ログ解析**: エラーログやスタックトレースを読み、例外の発生箇所を特定する
3. **コードトレース**: エラー発生箇所から呼び出し元をたどり、データフローを追跡する
4. **履歴調査**: `git log` で障害発生前後のコミットを確認し、関連する変更を特定する
5. **原因特定**: 収集した情報から根本原因の候補を絞り込み、最も可能性の高い原因を特定する
6. **復旧手順の策定**: 暫定対応（応急処置）と恒久対応（根本修正）を分けて提示する

## 出力フォーマット

```markdown
## 障害概要
- 症状: [何が起きているか]
- 影響範囲: [影響を受けるユーザー/機能]
- 重要度: [Critical/High/Medium]

## タイムライン
- [時刻] [イベント]
- [時刻] [イベント]

## 調査ログ
1. [確認した内容] → [判明した事実]
2. [確認した内容] → [判明した事実]

## 根本原因
[原因の説明。コード箇所・コミットハッシュを含める]

## 暫定対応（すぐにできる応急処置）
1. [手順]
2. [手順]

## 恒久対応（根本修正）
1. [手順]
2. [手順]

## 再発防止策
- [テスト追加]
- [監視強化]
- [コードレビュー観点の追加]
```

## 安全注意

- 本番環境に対する変更は提案のみ行い、実行しない
- 秘密情報（接続文字列、トークン等）がログに含まれていた場合はマスクする
- 暫定対応は副作用が最小限のものを選ぶ
- 調査中に発見した他の問題も記録する

## 終了条件

上記の出力フォーマットに従った調査レポートを出力したら停止する。修正の実行はユーザーの指示を待つ。
