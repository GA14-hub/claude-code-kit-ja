---
name: ci-coverage-gate
description: テストカバレッジの閾値と例外ルールを設計する。CI ゲートとして運用可能な設定を生成する。
argument-hint: "[project-dir|coverage-config] (任意でターゲットカバレッジ率)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

プロジェクトのコード構成とテスト状況を分析し、CI で運用するカバレッジ閾値と例外ルールを設計する。画一的な閾値ではなく、ディレクトリ・ファイル種別ごとに適切な基準を設定し、段階的にカバレッジを向上させる現実的な計画を策定する。

## 入力

- プロジェクトディレクトリまたはカバレッジ設定ファイルのパス（必須）
- 任意: 目標カバレッジ率（例: 80%）
- 任意: 既存のカバレッジレポート（lcov、coverage.xml 等）
- 任意: カバレッジ対象外としたいディレクトリ（テスト、マイグレーション等）
- 不足している場合はユーザーに質問する

## 手順

1. **プロジェクト構成の分析**
   - Glob でソースコードのディレクトリ構成を把握する
   - 以下のファイル種別を分類する:
     - **ビジネスロジック**: サービス層、ドメインモデル、ユーティリティ
     - **エントリポイント**: コントローラ、ルーター、ハンドラ
     - **設定・インフラ**: 設定ファイル、マイグレーション、シード
     - **型定義・インターフェース**: 型ファイル、プロトコル定義
     - **自動生成コード**: ORM モデル、GraphQL 型、API クライアント
   - テストファイルの配置を確認し、テストフレームワークを特定する

2. **既存カバレッジの把握**
   - カバレッジ設定ファイルを検索して読み取る:
     - Jest: `jest.config.*` の `coverageThreshold`、`collectCoverageFrom`
     - pytest: `pyproject.toml` の `[tool.coverage]`、`.coveragerc`
     - Go: カバレッジ関連の Makefile ターゲット
   - 既存のカバレッジレポートがある場合、現在のカバレッジ率を把握する
   - 既存の除外設定（`coveragePathIgnorePatterns` 等）を確認する

3. **閾値の設計**
   - ファイル種別ごとに適切なカバレッジ閾値を設計する:
     - **ビジネスロジック**: 高い閾値（80-90%）バグの影響が大きいため
     - **エントリポイント**: 中程度の閾値（60-75%）結合テストで補完
     - **ユーティリティ**: 高い閾値（85-95%）再利用頻度が高いため
     - **設定・インフラ**: 低い閾値または除外（テストの費用対効果が低い）
     - **自動生成コード**: 除外（手動テストの価値が低い）
   - 全体閾値と個別閾値の両方を設定し、段階的な引き上げ計画を含める

4. **例外ルールの策定**
   - カバレッジ対象外とすべきファイル・ディレクトリを明確にする:
     - テストファイル自体
     - 設定ファイル、マイグレーションファイル
     - 自動生成コード
     - 型定義のみのファイル
   - 例外を適用する理由を各項目に記載する
   - 例外ルールの濫用を防ぐガイドラインを設定する

5. **CI ゲート設定の生成**
   - プロジェクトのテストフレームワークに応じた設定を生成する:
     - カバレッジ閾値の設定
     - CI での実行コマンド
     - カバレッジレポートの出力形式（lcov、cobertura 等）
     - PR へのカバレッジコメント出力（Codecov、Coveralls 等）
   - 閾値を下回った場合の CI 挙動（失敗 / 警告）を設定する

6. **段階的導入計画の作成**
   - 現在のカバレッジ率が不明な場合、初期閾値を低めに設定し段階的に引き上げる計画を作る
   - マイルストーンごとの目標閾値とスケジュールを提案する
   - カバレッジ低下を検知するための差分チェック（新規コードのカバレッジ率）を提案する

## 出力フォーマット

```markdown
## プロジェクト分析

- **言語/フレームワーク**: [検出された言語]
- **テストフレームワーク**: [Jest/pytest/go test 等]
- **ソースディレクトリ数**: [対象ディレクトリ数]
- **推定ソースファイル数**: [テスト以外のファイル数]
- **既存カバレッジ設定**: [あり（概要）/ なし]

## カバレッジ閾値設計

### 全体閾値

| 指標 | 閾値 | 段階 |
|------|------|------|
| Line Coverage | [X%] | 初期 → [Y%] 目標 |
| Branch Coverage | [X%] | 初期 → [Y%] 目標 |
| Function Coverage | [X%] | 初期 → [Y%] 目標 |

### ディレクトリ別閾値

| ディレクトリ | 種別 | 閾値 | 理由 |
|-------------|------|------|------|
| [src/services/] | ビジネスロジック | [X%] | [理由] |
| [src/controllers/] | エントリポイント | [X%] | [理由] |
| [src/utils/] | ユーティリティ | [X%] | [理由] |

### 除外ルール

| 対象 | パターン | 除外理由 |
|------|---------|---------|
| [テストファイル] | [パターン] | [理由] |
| [自動生成コード] | [パターン] | [理由] |
| [マイグレーション] | [パターン] | [理由] |

## CI 設定

### カバレッジ設定ファイル

[テストフレームワークに応じた設定をコードブロックで出力]

### CI ワークフロー設定

[GitHub Actions のカバレッジ実行ステップをコードブロックで出力]

## 段階的導入計画

| フェーズ | 期間 | 全体目標 | 重点領域 |
|---------|------|---------|---------|
| Phase 1 | [期間] | [X%] | [対象] |
| Phase 2 | [期間] | [X%] | [対象] |
| Phase 3 | [期間] | [X%] | [対象] |

## 運用ルール

- **新規コード**: [新規コードに対する最低カバレッジ率]
- **例外申請**: [閾値の例外を認める条件とプロセス]
- **定期見直し**: [閾値を見直すタイミングと基準]
```

## 安全注意

- カバレッジ設定ファイルの直接編集は行わず、設定テンプレートの出力のみ行う
- 非現実的な閾値（初期から 100%）を設定しない。チームのモチベーション低下を招く
- カバレッジ率だけでテスト品質を判断しない旨の注意書きを含める
- 自動生成コードやサードパーティコードを測定対象に含めない
- テストデータに本番データや個人情報を使用する設定を含めない

## 終了条件

上記の出力フォーマットに従ったカバレッジゲート設計書を出力したら停止する。閾値設計（全体・ディレクトリ別）、例外ルール、CI 設定テンプレート、段階的導入計画が含まれていること。設定ファイルの適用はユーザーの指示を待つ。
