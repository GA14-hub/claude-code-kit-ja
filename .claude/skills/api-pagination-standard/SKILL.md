---
name: api-pagination-standard
description: APIのページネーション・フィルタリング・ソートの実装を分析し、統一規格を策定する。一貫性のあるリスト操作仕様を設計する。
argument-hint: "[APIコードベース|リスト系エンドポイント|対象ディレクトリ] (任意で規格方針)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

API のリスト系エンドポイントにおけるページネーション・フィルタリング・ソートの実装を分析し、統一された規格を策定する。現行の実装に不統一がある場合はそれを検出し、クライアントが一貫した方法でデータ取得できるよう標準仕様を設計する。大量データの効率的な取得、パフォーマンスへの配慮、ユーザビリティの3つの観点からバランスの取れた仕様を目指す。

## 入力

- API コードベースのディレクトリパスまたはリスト系エンドポイントのファイル（必須）
- 既存のページネーション規約（任意）
- データ規模の見込み（任意: レコード数のオーダー）
- 優先する規格方針（任意: offset / cursor / keyset）
- 不足している場合はユーザーに質問する

## 手順

1. **現行実装の棚卸し**
   - Grep でページネーション関連のパラメータ（`page`、`limit`、`offset`、`cursor`、`per_page`、`skip`、`take` 等）の使用箇所を検索する
   - フィルタリングの実装パターン（クエリパラメータ、リクエストボディ、カスタムクエリ言語等）を検出する
   - ソートの実装パターン（`sort`、`order`、`order_by`、`sort_by` 等）を検出する
   - レスポンスのメタデータ構造（総件数、次ページ情報、ページ数等）を収集する
   - 各エンドポイント間の不統一箇所を一覧化する

2. **ページネーション方式の選定**
   - 以下の方式を比較評価し、プロジェクトに最適な方式を選定する:
     - **オフセットベース**（`?page=2&per_page=20`）: 実装簡単、ページジャンプ可能、大量データで遅い
     - **カーソルベース**（`?cursor=abc123&limit=20`）: 大量データに強い、リアルタイム更新に安定、ページジャンプ不可
     - **キーセットベース**（`?after_id=100&limit=20`）: パフォーマンス良好、ソート順固定、実装やや複雑
   - ユースケース別に方式を使い分ける必要がある場合はその基準を定める
   - デフォルトのページサイズと最大ページサイズを決定する

3. **フィルタリング規格の設計**
   - フィルタパラメータの命名規約を定める（例: `filter[status]=active`、`status=active`）
   - サポートする演算子を定義する:
     - 等値: `filter[status]=active`
     - 範囲: `filter[created_at][gte]=2024-01-01`
     - 部分一致: `filter[name][like]=tanaka`
     - 複数値: `filter[status]=active,pending`
   - フィルタ可能なフィールドの明示方針を定める（ホワイトリスト方式）
   - 不正なフィルタパラメータへの対応方針を定める（無視 vs エラー返却）

4. **ソート規格の設計**
   - ソートパラメータの書式を定める（例: `sort=created_at` / `sort=-created_at` / `sort=name:asc`）
   - 複数フィールドソートの書式を定める（例: `sort=status,-created_at`）
   - ソート可能なフィールドの制限方針を定める
   - デフォルトのソート順を定める（未指定時の挙動）
   - インデックスとの整合性を確認し、パフォーマンス上の注意事項を記載する

5. **レスポンス構造の標準化**
   - ページネーションメタデータの共通構造を設計する
   - 方式別のレスポンスサンプルを作成する:
     - オフセット: `total_count`、`page`、`per_page`、`total_pages`
     - カーソル: `next_cursor`、`has_next`、`prev_cursor`、`has_prev`
   - リンクヘッダー（RFC 8288）または HATEOAS リンクの採用可否を判断する
   - 空結果時のレスポンス仕様を定める
   - 総件数の返却方針を決定する（常に返す / リクエスト時のみ / 概算値）

6. **移行計画と適用ガイドの作成**
   - 現行実装から標準仕様への移行手順を作成する
   - エンドポイント別の対応要否と優先度を判定する
   - 移行時の後方互換性維持方針を定める
   - 新規エンドポイント作成時の適用ガイドラインを作成する

## 出力フォーマット

```markdown
## ページネーション・フィルタ・ソート標準規格書

### 現状分析

#### 検出されたパターン

| エンドポイント | ページネーション | フィルタ | ソート | 準拠状況 |
|--------------|----------------|---------|-------|---------|
| [パス] | [方式/パラメータ名] | [方式] | [方式] | [統一/不統一] |

#### 不統一箇所

| 項目 | パターンA | パターンB | 該当エンドポイント |
|------|----------|----------|----------------|
| ページサイズ | `limit` | `per_page` | [エンドポイント一覧] |

### 標準規格

#### ページネーション

- **採用方式**: [オフセット/カーソル/キーセット]
- **選定理由**: [理由]
- **デフォルトページサイズ**: [件数]
- **最大ページサイズ**: [件数]

**リクエスト例**:
```
GET /api/v1/resources?page=2&per_page=20
```

**レスポンス構造**:
```json
{
  "data": [...],
  "meta": {
    "current_page": 2,
    "per_page": 20,
    "total_count": 150,
    "total_pages": 8
  },
  "links": {
    "first": "/api/v1/resources?page=1&per_page=20",
    "prev": "/api/v1/resources?page=1&per_page=20",
    "next": "/api/v1/resources?page=3&per_page=20",
    "last": "/api/v1/resources?page=8&per_page=20"
  }
}
```

#### フィルタリング

- **パラメータ書式**: [例: `filter[field]=value`]
- **サポート演算子**:

| 演算子 | 書式 | 例 | 用途 |
|--------|------|-----|------|
| 等値 | `filter[field]=value` | `filter[status]=active` | 完全一致 |
| 範囲(以上) | `filter[field][gte]=value` | `filter[price][gte]=1000` | 下限指定 |
| 範囲(以下) | `filter[field][lte]=value` | `filter[price][lte]=5000` | 上限指定 |
| 部分一致 | `filter[field][like]=value` | `filter[name][like]=田中` | 前方/部分一致 |
| 複数値 | `filter[field]=v1,v2` | `filter[status]=active,pending` | IN 検索 |

- **フィルタ可能フィールド制限**: [ホワイトリスト方式で明示]
- **不正パラメータ時の挙動**: [400エラー返却/無視して警告ヘッダー付与]

#### ソート

- **パラメータ書式**: [例: `sort=field` / `sort=-field`（降順）]
- **複数フィールド**: [例: `sort=status,-created_at`]
- **デフォルトソート**: [例: `-created_at`（新しい順）]

**リクエスト例**:
```
GET /api/v1/resources?sort=-created_at,name&filter[status]=active&page=1&per_page=20
```

### パフォーマンス考慮事項

| 考慮事項 | 対策 | 備考 |
|---------|------|------|
| 大量データのCOUNT | [概算値の使用/閾値超過時の省略] | [詳細] |
| ソートとインデックス | [インデックス必須フィールドの明示] | [詳細] |
| 深いページ参照 | [最大ページ制限/カーソルへの切り替え] | [詳細] |

### 移行計画

| エンドポイント | 現状 | 変更内容 | 優先度 | 後方互換 |
|--------------|------|---------|-------|---------|
| [パス] | [現状の実装] | [必要な変更] | P1/P2/P3 | [互換性維持方法] |

### 新規エンドポイント適用ガイドライン

1. [リスト系エンドポイントは必ず本規格に準拠する]
2. [フィルタ可能フィールドを API ドキュメントに明示する]
3. [デフォルトソートを必ず設定する]
4. [最大ページサイズを超えるリクエストは 400 エラーを返す]
```

## 安全注意

- 規格書の作成のみを行い、エンドポイントの実装変更は実施しない
- フィルタリングで SQL インジェクションにつながるパターン（ユーザー入力を直接 SQL に埋め込む）を発見した場合は警告する
- 大量データのフィルタなしの全件取得がパフォーマンスリスクになる場合は必ず指摘する
- フィルタ可能フィールドにセンシティブ情報（パスワードハッシュ、内部 ID 等）が含まれないよう注意する
- 総件数の返却がパフォーマンスに悪影響を与える場合はその旨を記載する

## 終了条件

上記の出力フォーマットに従った標準規格書を出力したら停止する。ページネーション・フィルタリング・ソートの各規格が定義され、現行実装との差異と移行計画が記載されていること。実装作業はユーザーの指示を待つ。
