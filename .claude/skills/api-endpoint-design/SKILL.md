---
name: api-endpoint-design
description: 要件からRESTful APIエンドポイントを設計する。命名規則・粒度・エラーハンドリング・レスポンス構造を統一的に定義する。
argument-hint: "[要件ドキュメント|既存APIコード|機能説明] (任意でAPI規約ファイル)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

要件定義や機能説明を起点に、一貫性のある RESTful API エンドポイントを設計する。リソース命名・URL 構造・HTTP メソッドの選定・リクエスト/レスポンス構造・エラーハンドリングまでを体系的に定義し、フロントエンド開発者や外部連携先がすぐに利用できる仕様書を作成する。既存 API がある場合はその規約との整合性も確認する。

## 入力

- 要件ドキュメント、機能説明、またはユースケース記述（必須）
- 既存 API のコードベースまたはルーティング定義ファイル（任意）
- API 設計規約・スタイルガイド（任意）
- 対象のドメインモデルや DB スキーマ（任意）
- 不足している場合はユーザーに質問する

## 手順

1. **既存 API の規約調査**
   - Glob でルーティング定義ファイル（`routes.*`、`router.*`、`urls.py`、`controller.*` 等）を検索する
   - 既存エンドポイントの命名パターン（複数形/単数形、ケバブケース/スネークケース等）を分析する
   - レスポンス構造の共通パターン（エンベロープ形式の有無、メタデータ構造等）を把握する
   - 認証方式、バージョニング方式、ヘッダー規約を確認する

2. **リソースモデリング**
   - 要件からリソース（名詞）を抽出し、RESTful なリソース階層を設計する
   - リソース間の関係性（親子関係、多対多等）を整理し、URL ネスト方針を決定する
   - サブリソースの深さは最大2階層を原則とし、それ以上はクエリパラメータで表現する
   - アクション系操作（承認、キャンセル等）の表現方法を決定する（POST サブリソース or カスタムアクション）

3. **エンドポイント詳細設計**
   - 各エンドポイントの HTTP メソッド・パス・パラメータを定義する
   - リクエストボディのスキーマ（必須/任意フィールド、型、バリデーションルール）を設計する
   - レスポンスボディのスキーマ（フィールド、型、ネスト構造）を設計する
   - 適切な HTTP ステータスコードを選定する（200/201/204/400/401/403/404/409/422/500）

4. **エラーハンドリング設計**
   - 各エンドポイントで発生しうるエラーケースを列挙する
   - エラーレスポンスの統一フォーマットを定義する（エラーコード、メッセージ、詳細）
   - バリデーションエラーの表現方法（フィールド単位のエラー配列等）を設計する
   - レート制限、認証エラー、権限エラーの返却方針を定める

5. **冪等性・安全性の確認**
   - 各エンドポイントの冪等性を確認し、冪等キーの要否を判断する
   - 安全なメソッド（GET/HEAD）に副作用がないことを確認する
   - PUT と PATCH の使い分け方針を明確にする
   - 同時実行制御が必要なエンドポイントに ETag/If-Match の導入を検討する

6. **既存 API との整合性チェック**
   - 新規エンドポイントが既存の命名規約・レスポンス構造に準拠しているか確認する
   - 既存エンドポイントとの重複や矛盾がないか検証する
   - バージョニングが必要な変更がないか確認する

## 出力フォーマット

```markdown
## API エンドポイント設計書

### 設計方針
- **命名規約**: [例: 複数形ケバブケース `/api/v1/user-profiles`]
- **バージョニング**: [例: URL パスプレフィックス `/api/v1/`]
- **レスポンス形式**: [例: エンベロープ形式 `{ data, meta, errors }`]
- **認証方式**: [例: Bearer トークン]

### リソース一覧

| リソース | 説明 | 親リソース |
|---------|------|-----------|
| [リソース名] | [説明] | [なし/親リソース名] |

### エンドポイント詳細

#### [メソッド] [パス]

- **説明**: [このエンドポイントの目的]
- **認証**: [必要/不要]
- **冪等性**: [あり/なし]

**リクエスト**:
| パラメータ | 位置 | 型 | 必須 | 説明 | バリデーション |
|-----------|------|-----|------|------|--------------|
| [名前] | path/query/body | [型] | [Yes/No] | [説明] | [ルール] |

**レスポンス**:
| ステータス | 説明 | ボディ |
|-----------|------|-------|
| 200 | 成功 | `{ data: { ... } }` |
| 400 | バリデーションエラー | `{ errors: [{ field, code, message }] }` |
| 404 | リソース未発見 | `{ error: { code, message } }` |

#### [メソッド] [パス]
（以下同様に繰り返す）

### エラーレスポンス共通仕様

| HTTP ステータス | エラーコード | 使用条件 | レスポンス例 |
|---------------|------------|---------|------------|
| 400 | VALIDATION_ERROR | 入力値不正 | `{ error: { code: "VALIDATION_ERROR", ... } }` |
| 401 | UNAUTHORIZED | 認証失敗 | `{ error: { code: "UNAUTHORIZED", ... } }` |

### 設計上の判断と理由

| 判断事項 | 選択 | 理由 |
|---------|------|------|
| [例: ネスト深度] | [最大2階層] | [URL の可読性とキャッシュ容易性] |

### 既存 API との整合性

- **準拠項目**: [既存規約との一致点]
- **差異・要注意点**: [既存規約との差異がある場合]
```

## 安全注意

- 認証トークンやシークレットの具体値を設計書に含めない
- 設計書の作成のみを行い、ルーティングコードの変更は実施しない
- 既存 API の破壊的変更を伴う設計をする場合はユーザーに警告する
- 個人情報を扱うエンドポイントには明示的にその旨を記載する
- 管理者向けエンドポイントと一般ユーザー向けエンドポイントを明確に区別する

## 終了条件

上記の出力フォーマットに従った API エンドポイント設計書を出力したら停止する。すべてのエンドポイントについてリクエスト/レスポンスのスキーマが定義され、エラーハンドリングの共通仕様が記載されていること。実装作業はユーザーの指示を待つ。
