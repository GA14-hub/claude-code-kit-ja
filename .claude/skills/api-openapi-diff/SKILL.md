---
name: api-openapi-diff
description: OpenAPI仕様の差分を検出し、破壊的変更の有無を判定して修正計画を立てる。APIバージョンアップ時の安全性を確保する。
argument-hint: "[旧OpenAPIファイル 新OpenAPIファイル|APIコードベース] (任意でバージョン情報)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git diff *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

OpenAPI（Swagger）仕様ファイルの新旧差分を解析し、破壊的変更（Breaking Change）を検出する。検出した変更を「破壊的」「非破壊的」「追加」に分類し、破壊的変更に対しては影響範囲の評価と段階的な修正計画を提示する。API の後方互換性を維持しながら安全にバージョンアップするための判断材料を提供する。

## 入力

- 旧バージョンと新バージョンの OpenAPI 仕様ファイル（YAML/JSON）、または API コードベース（必須）
- 比較対象の git ブランチ・タグ・コミット（任意）
- 影響を受けるクライアントの情報（任意）
- 移行スケジュールの制約（任意）
- 不足している場合はユーザーに質問する

## 手順

1. **OpenAPI 仕様ファイルの特定と読み取り**
   - Glob で OpenAPI 仕様ファイル（`openapi.*`、`swagger.*`、`api-spec.*` 等）を検索する
   - 指定されたファイルまたは検出したファイルを Read で読み取る
   - git 管理下の場合、`git diff` で仕様ファイルの変更差分を取得する
   - 仕様ファイルが複数に分割されている場合は `$ref` の参照先も追跡する

2. **差分の構造的解析**
   - パス（エンドポイント）レベルの差分を検出する: 追加・削除・変更
   - 各エンドポイントについて以下の要素の変更を検出する:
     - HTTP メソッドの追加・削除
     - リクエストパラメータ（path/query/header）の追加・削除・型変更・必須化
     - リクエストボディのスキーマ変更（フィールド追加・削除・型変更・必須化）
     - レスポンスのスキーマ変更（フィールド追加・削除・型変更）
     - レスポンスのステータスコード変更
   - 共通コンポーネント（schemas/parameters/responses）の変更を検出する
   - セキュリティスキームの変更を検出する

3. **破壊的変更の判定**
   - 以下を破壊的変更として分類する:
     - エンドポイントの削除
     - リクエストパラメータの必須化（optional → required）
     - リクエスト/レスポンスフィールドの型変更
     - レスポンスフィールドの削除
     - enum 値の削除
     - URL パスの変更
     - 認証方式の変更
   - 以下を非破壊的変更として分類する:
     - 新規エンドポイントの追加
     - オプショナルなリクエストパラメータの追加
     - レスポンスフィールドの追加
     - enum 値の追加
     - 説明文の修正
   - グレーゾーンの変更（デフォルト値の変更等）は個別に影響を評価する

4. **影響範囲の評価**
   - 破壊的変更ごとに影響を受けるクライアント操作を特定する
   - Grep でコードベース内の該当エンドポイント呼び出し箇所を検索する
   - 影響の深刻度を評価する（即座にエラー / データ不整合リスク / 機能劣化）
   - 破壊的変更の依存関係を整理する（変更Aを適用しないと変更Bが不可能等）

5. **修正計画の策定**
   - 破壊的変更ごとに修正アプローチを提案する:
     - 互換性レイヤーの追加（旧フィールドの維持＋非推奨マーク）
     - バージョニングによる新旧共存
     - クライアント移行期間の設定と段階的廃止
   - 移行手順をフェーズに分けて整理する
   - 各フェーズでのロールバック方法を記載する

6. **互換性チェックリストの作成**
   - リリース前に確認すべき項目をチェックリスト形式でまとめる
   - クライアントへの通知・ドキュメント更新の必要性を判定する
   - モニタリング項目（旧エンドポイントのアクセス状況等）を定義する

## 出力フォーマット

```markdown
## OpenAPI 差分レポート

### 比較対象
- **旧バージョン**: [ファイル名/バージョン/コミット]
- **新バージョン**: [ファイル名/バージョン/コミット]
- **検出日**: [日付]

### 変更サマリ

| 分類 | 件数 |
|------|------|
| 破壊的変更 | X件 |
| 非破壊的変更 | X件 |
| 新規追加 | X件 |
| 削除 | X件 |

### 破壊的変更一覧

#### BREAKING-001: [変更の概要]

- **エンドポイント**: [メソッド パス]
- **変更内容**: [具体的な変更]
- **影響**: [クライアントへの影響]
- **深刻度**: [Critical/High/Medium]
- **修正アプローチ**: [推奨する対応方法]
- **旧仕様**:
  ```yaml
  [変更前の仕様抜粋]
  ```
- **新仕様**:
  ```yaml
  [変更後の仕様抜粋]
  ```

#### BREAKING-002: [変更の概要]
（以下同様に繰り返す）

### 非破壊的変更一覧

| エンドポイント | 変更内容 | 種別 |
|--------------|---------|------|
| [メソッド パス] | [変更内容] | 追加/修正 |

### 移行計画

#### Phase 1: 互換性レイヤーの導入（推奨期間: X週間）
- [ ] [具体的な対応項目]
- [ ] [具体的な対応項目]

#### Phase 2: クライアント移行期間（推奨期間: X週間）
- [ ] [具体的な対応項目]
- [ ] [具体的な対応項目]

#### Phase 3: 旧仕様の廃止
- [ ] [具体的な対応項目]
- [ ] [具体的な対応項目]

### リリース前チェックリスト

- [ ] すべての破壊的変更に互換性レイヤーまたはバージョニングが適用されている
- [ ] クライアント向け移行ガイドが作成されている
- [ ] 旧エンドポイントのアクセスモニタリングが設定されている
- [ ] ロールバック手順が確認されている
- [ ] API ドキュメントが更新されている
```

## 安全注意

- 仕様ファイルの読み取りと差分分析のみを行い、仕様ファイルの変更は実施しない
- `git diff` 以外の git 操作（reset、checkout 等）は実行しない
- 認証情報やシークレットが仕様ファイルに含まれている場合は出力時にマスクする
- 破壊的変更が検出された場合は必ずユーザーに警告し、安易なリリースを防ぐ
- 本番環境の API に対する直接的なテストリクエストは実行しない

## 終了条件

上記の出力フォーマットに従った差分レポートを出力したら停止する。すべての変更が「破壊的」「非破壊的」「追加」に分類され、破壊的変更には修正アプローチと移行計画が記載されていること。仕様変更の実施はユーザーの指示を待つ。
