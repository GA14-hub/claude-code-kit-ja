---
name: refactor-plan
description: リファクタリングの計画書を作成する。影響範囲・リスク・手順を整理してから実行に移る。
argument-hint: "[file-path|function-name|module] (任意でリファクタの目的)"
user-invocable: true
disable-model-invocation: true
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

リファクタリングを実行する前に、対象コードの問題点・影響範囲・リスクを洗い出し、安全に進めるための計画書を作成する。

## 入力

- 対象ファイル、関数名、またはモジュール（必須）
- リファクタの目的（任意: 可読性改善、パフォーマンス向上、責務分離等）
- 不足している場合はユーザーに質問する

## 手順

1. **現状分析**: 対象コードを読み、構造・依存関係・責務を把握する
2. **問題点の特定**: コードスメル（長すぎる関数、重複コード、過度な結合等）を列挙する
3. **影響範囲の調査**: 対象コードを参照している箇所を Grep で検索し、変更が波及するファイル・関数を特定する
4. **ターゲット設計**: リファクタ後のあるべき構造を設計する
5. **実行手順の策定**: 小さなステップに分割し、各ステップでテストが通る状態を維持する手順を作る
6. **リスク評価**: 各ステップのリスクとロールバック方法を記録する

## 出力フォーマット

```markdown
## 対象コード
- ファイル: [パス]
- 関数/クラス: [名前]
- 行数: [現在の行数]

## 現状の問題点
- [問題点1: 具体的な説明]
- [問題点2: 具体的な説明]

## リファクタ方針
[どのような構造に変えるか。1-3文で簡潔に]

## 影響範囲

| ファイル | 変更内容 | リスク |
|---------|---------|-------|
| ... | ... | 低/中/高 |

## 実行手順
1. [ステップ1: テストが通る状態を維持]
2. [ステップ2: テストが通る状態を維持]
3. ...

## ロールバック手順
- `git stash` または `git checkout` で元に戻せることを確認
- 各ステップ完了時にコミットしておく

## 完了条件
- [ ] 全テストが通る
- [ ] 対象の問題点が解消されている
- [ ] 新たなコードスメルを持ち込んでいない
```

## 安全注意

- 計画書の段階ではコードを編集しない
- 影響範囲が広い場合はユーザーに警告する
- テストがない場合は「先にテストを追加する」ステップを含める
- `git diff` で差分を確認してからコミットすることを手順に含める

## 終了条件

上記の出力フォーマットに従った計画書を出力したら停止する。実際のリファクタリング作業はユーザーの指示を待つ。
