---
name: db-migration-review
description: "マイグレーションファイルの危険パターン検出（ロック・大規模ALTER・データ損失）"
argument-hint: "マイグレーションファイルパス or ディレクトリ"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

マイグレーションファイルを静的解析し、本番環境で問題を引き起こす危険パターンを検出する。テーブルロック、大規模 ALTER TABLE、データ損失、整合性破壊などのリスクを事前に発見し、安全な代替手法を提案する。

## 入力

- マイグレーションファイル（SQL / ORM マイグレーションファイル）
- マイグレーションディレクトリ（複数ファイルの一括レビュー）
- 関連するスキーマ定義ファイル（任意）

## 手順

### 1. マイグレーションファイルの収集と解析

1-1. 指定パスからマイグレーションファイルを特定する
1-2. SQL文 または ORM のマイグレーション定義を解析する
1-3. 各マイグレーションの操作種別（DDL / DML）を分類する
1-4. 実行順序の依存関係を確認する

### 2. 危険パターンの検出

以下のパターンを網羅的に検査する:

**テーブルロック系**
2-1. `ALTER TABLE` による排他ロックの発生箇所を特定する
2-2. `LOCK TABLES` / `LOCK TABLE` の明示的使用を検出する
2-3. 長時間トランザクション内での DDL 実行を検出する
2-4. インデックス作成時の `ALGORITHM=COPY` 相当の操作を検出する

**データ損失系**
2-5. `DROP TABLE` / `DROP COLUMN` によるデータ削除を検出する
2-6. `TRUNCATE TABLE` によるデータ全削除を検出する
2-7. データ型の縮小変更（VARCHAR(255)→VARCHAR(100) 等）を検出する
2-8. NOT NULL 制約追加時の既存NULLデータ消失リスクを検出する
2-9. `DELETE FROM` による条件付きデータ削除を検出する

**パフォーマンス系**
2-10. 大規模テーブルへの `ADD COLUMN` with DEFAULT を検出する
2-11. 複合インデックスの不適切な列順序を検出する
2-12. 不要な `FORCE INDEX` / `USE INDEX` を検出する

**整合性系**
2-13. 外部キー制約なしのリレーション列追加を検出する
2-14. `CASCADE DELETE` の連鎖的影響を検出する
2-15. ロールバック SQL の欠如を検出する
2-16. トランザクション境界の不備を検出する

### 3. リスク評価とスコアリング

3-1. 各検出項目に重大度を付与する（CRITICAL / HIGH / MEDIUM / LOW）
3-2. 影響を受けるテーブルの推定規模を評価する
3-3. ダウンタイム発生の可能性を判定する
3-4. データ損失の可逆性を評価する

### 4. 安全な代替手法の提案

4-1. 検出された各危険パターンに対する安全な代替案を記述する
4-2. オンラインDDL（pt-online-schema-change / gh-ost 等）の適用可能性を評価する
4-3. 段階的マイグレーション（複数ステップ分割）の提案を行う
4-4. Blue-Green デプロイとの連携手法を提案する

### 5. ロールバック安全性の検証

5-1. DOWN マイグレーションの存在を確認する
5-2. ロールバック SQL がデータ復元可能かを検証する
5-3. ロールバック不可能な操作を明示する
5-4. 部分ロールバックの手順が必要かを判定する

### 6. 総合判定

6-1. マイグレーション全体の安全性を総合判定する（APPROVE / CONDITIONAL / REJECT）
6-2. CONDITIONAL の場合、承認条件を具体的に記述する
6-3. 本番適用前に必要な追加テストを列挙する

## 出力フォーマット

```markdown
# マイグレーションレビュー: [ファイル名]

## 総合判定: [APPROVE / CONDITIONAL / REJECT]

## 検出サマリ
| 重大度 | 件数 | 主な検出内容 |
|--------|------|-------------|
| CRITICAL | N件 | [概要] |
| HIGH | N件 | [概要] |
| MEDIUM | N件 | [概要] |
| LOW | N件 | [概要] |

## 検出詳細

### [CRITICAL] [検出項目名]
- **箇所**: `file:line` - 該当SQL文
- **リスク**: [具体的な障害シナリオ]
- **影響**: [ダウンタイム / データ損失 / パフォーマンス劣化]
- **代替案**: [安全な実装方法]

```sql
-- 危険なパターン
ALTER TABLE large_table ADD COLUMN new_col VARCHAR(255) NOT NULL DEFAULT '';

-- 推奨する代替案
-- Step 1: NULL許容でカラム追加
ALTER TABLE large_table ADD COLUMN new_col VARCHAR(255) NULL;
-- Step 2: バッチ処理でデフォルト値を設定
-- Step 3: NOT NULL制約を追加
```

### [HIGH] [検出項目名]
- **箇所**: `file:line` - 該当SQL文
- **リスク**: [具体的な障害シナリオ]
- **影響**: [影響内容]
- **代替案**: [安全な実装方法]

## ロールバック安全性
| マイグレーション | ロールバック可否 | 理由 |
|-----------------|----------------|------|
| [操作名] | 可能 / 不可能 / 条件付き | [説明] |

## 承認条件（CONDITIONAL の場合）
1. [修正すべき事項]
2. [追加で必要なテスト]
3. [実行時の制約条件]

## 推奨アクション
- [ ] [具体的な修正指示]
- [ ] [追加テスト項目]
- [ ] [実行前の確認事項]
```

## 安全注意

- **絶対に実際の SQL を実行しないこと** -- 本スキルは静的解析のみを行う
- **本番データベースへの接続を行わないこと**
- **マイグレーションファイルの内容を変更しないこと** -- レビュー結果の報告のみ
- **CRITICAL 判定の検出項目がある場合、必ずファイル冒頭で警告すること**
- **データ損失を伴う操作は、バックアップ手順の明記を必須とすること**
- **推定ではなく確実に判定できる項目のみ CRITICAL とすること**
- **ORM 固有のマイグレーション構文も正確に解析すること**（Rails, Django, Alembic, Knex 等）

## 終了条件

- すべてのマイグレーションファイルが解析されていること
- 危険パターンの検出結果が重大度付きで報告されていること
- 各検出項目に対する安全な代替案が提示されていること
- ロールバックの安全性が評価されていること
- 総合判定（APPROVE / CONDITIONAL / REJECT）が下されていること
- CONDITIONAL の場合、承認条件が具体的に記述されていること

## このスキルが向かないケース

- **APPROVE 判定を最終承認として扱うケース**: このスキルのレビューはコードベースの静的分析に基づく。本番データ量・負荷特性・レプリケーション構成は考慮できないため、DBA の確認を省略しないこと
- **ORM 固有の挙動に依存するマイグレーション**: 生の SQL ベースの分析が主体。ORM のランタイム挙動（遅延実行、フック等）までは検出できない
