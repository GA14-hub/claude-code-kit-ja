---
name: ops-metric-plan
description: システムの監視メトリクスを設計し、ダッシュボード構成を提案する。何を・なぜ・どう測るかを体系的に整理する。
argument-hint: "[サービス名 or コードベースのパス] (任意でフォーカス: latency/error-rate/saturation)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

対象システムのコードベースを分析し、監視すべきメトリクスを RED（Rate / Errors / Duration）メソッドおよび USE（Utilization / Saturation / Errors）メソッドに基づいて設計する。メトリクスの取得方法、閾値の目安、ダッシュボードのレイアウト案を提案する。

## 入力

- 対象サービス名またはコードベースのパス（必須）
- 任意: フォーカスしたい領域（レイテンシ / エラーレート / リソース飽和度）
- 任意: 既存の監視ツール（Datadog / Grafana / CloudWatch 等）
- 任意: SLO/SLA の定義がある場合はその情報
- 不足している場合はユーザーに質問する

## 手順

1. **システム構成の把握**
   - Glob でプロジェクトの構成ファイルを検索する（`docker-compose.yml`、`k8s/`、`Dockerfile` 等）
   - Read でアプリケーションのエントリポイントやルーティングを確認する
   - Grep で既存のメトリクス計装コードを検索する（`metrics`、`prometheus`、`statsd`、`counter`、`histogram`）
   - API エンドポイント、バックグラウンドジョブ、外部サービス連携を洗い出す

2. **RED メトリクスの設計（リクエスト駆動型）**
   - Rate: リクエスト数/秒をエンドポイント別に定義する
   - Errors: エラー率をステータスコード別・エンドポイント別に定義する
   - Duration: レスポンスタイムを p50 / p95 / p99 で定義する
   - 各メトリクスの計測ポイント（ミドルウェア / ハンドラ / クライアント側）を特定する

3. **USE メトリクスの設計（リソース駆動型）**
   - Utilization: CPU / メモリ / ディスク / ネットワーク帯域の使用率を定義する
   - Saturation: キュー長 / スレッドプール使用率 / コネクションプール使用率を定義する
   - Errors: システムレベルのエラー（OOM、ディスクフル、コネクション拒否）を定義する

4. **ビジネスメトリクスの設計**
   - コードから推定できるビジネスイベント（ユーザー登録、購入、検索 等）を特定する
   - 各イベントの成功率・処理時間をメトリクス候補として追加する

5. **ダッシュボード構成の設計**
   - 概要ダッシュボード（ゴールデンシグナル 4 指標を一覧）のレイアウトを設計する
   - 詳細ダッシュボード（エンドポイント別、リソース別）の構成を設計する
   - 各パネルのグラフ種別（折れ線 / ヒートマップ / ゲージ / テーブル）を選定する

## 出力フォーマット

```markdown
## システム概要

- **サービス名**: [サービス名]
- **主要コンポーネント**: [Web サーバー / ワーカー / DB / キャッシュ 等]
- **既存の計装**: [あり（ツール名）/ なし]

## メトリクス設計

### RED メトリクス（リクエスト駆動型）

| メトリクス名 | 種別 | 計測対象 | 計測ポイント | 推奨閾値 |
|-------------|------|---------|-------------|---------|
| http_requests_total | Rate | 全エンドポイント | ミドルウェア | - |
| http_errors_ratio | Errors | 5xx 応答率 | ミドルウェア | < 1% |
| http_duration_seconds | Duration | レスポンスタイム p95 | ミドルウェア | < 500ms |

### USE メトリクス（リソース駆動型）

| メトリクス名 | 種別 | 計測対象 | 推奨閾値 |
|-------------|------|---------|---------|
| [メトリクス名] | U/S/E | [対象] | [閾値] |

### ビジネスメトリクス

| メトリクス名 | イベント | 計測ポイント | 期待値 |
|-------------|---------|-------------|--------|
| [メトリクス名] | [イベント] | [コード上の位置] | [期待値] |

## ダッシュボード構成案

### 概要ダッシュボード
[レイアウト図（テキストベース）と各パネルの説明]

### 詳細ダッシュボード
[エンドポイント別 / リソース別のパネル構成]

## 計装の実装ガイド

1. [メトリクスライブラリの導入手順]
2. [計装コードの追加箇所と実装例]
3. [ダッシュボードの設定手順]
```

## 安全注意

- コードの変更は一切行わない（分析と提案のみ）
- 既存のメトリクス計装がある場合は破壊しない設計にする
- 推奨閾値は一般的な目安であり、実環境での調整が必要であることを明記する
- 個人情報やビジネス機密に関わるメトリクス名は一般化して記述する
- 監視ツール固有の設定は参考情報とし、ツール非依存の設計を基本とする

## 終了条件

上記の出力フォーマットに従ったメトリクス設計レポートを出力したら停止する。RED / USE / ビジネスメトリクスの定義、ダッシュボード構成案、計装の実装ガイドが含まれていること。実装はユーザーの指示を待つ。
