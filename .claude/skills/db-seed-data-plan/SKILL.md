---
name: db-seed-data-plan
description: "テスト・検証用のシードデータ設計計画を作成する"
argument-hint: "スキーマ定義ファイルパス or テーブル名"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 実行モード

- **簡易モード**（デフォルト）: 手順1（スキーマ分析）、3（データパターン設計）、5（スクリプト仕様）のみ実行し、簡潔なシードデータ計画を返す
- **詳細モード**: `--detailed` を引数に追加すると、全6手順を実行し検証基準・環境別設計を含む包括的な出力を返す

$ARGUMENTS に `--detailed` が含まれていない場合は簡易モードで実行する。簡易モードでは出力フォーマットの該当セクションのみ出力する。

## 目的

テスト・開発・ステージング環境で使用するシードデータの設計計画を作成する。外部キー制約やビジネスルールを満たしつつ、エッジケースを網羅する現実的なテストデータセットを設計する。データの投入順序と依存関係を明確にし、再現可能なシードスクリプトの仕様を策定する。

## 入力

- スキーマ定義ファイル（テーブル構造・制約情報）
- ORM モデル定義ファイル
- ビジネスロジックの仕様（任意）
- 既存のシードスクリプト（任意）
- テスト要件・シナリオ（任意）

## 手順

### 1. スキーマ構造の分析

1-1. 全テーブルのカラム定義・制約・データ型を把握する
1-2. テーブル間の外部キー依存関係を依存グラフとして整理する
1-3. NOT NULL / UNIQUE / CHECK 制約を一覧化する
1-4. ENUM 型 / ステータスカラムの取り得る値を列挙する
1-5. 自動生成カラム（AUTO_INCREMENT, SERIAL, UUID, タイムスタンプ）を特定する

### 2. データ投入順序の決定

2-1. 外部キー依存関係に基づくトポロジカルソート順を決定する
2-2. 循環参照がある場合の解決戦略を策定する（一時的FK無効化 or NULL後更新）
2-3. マスタデータ（参照テーブル）とトランザクションデータを区別する
2-4. 投入フェーズを定義する（Phase 1: マスタ → Phase 2: トランザクション → Phase 3: 関連データ）

### 3. データパターンの設計

3-1. 正常系データセットを設計する（基本的なCRUD操作の検証用）
3-2. 境界値データを設計する（最小値、最大値、空文字、長大文字列）
3-3. エッジケースデータを設計する:
  - NULL 許容カラムの NULL ケース
  - 論理削除済みレコード
  - ステータス遷移の全パターン
  - 日付境界（年末年始、閏年、タイムゾーン境界）
3-4. リレーション検証データを設計する:
  - 1対1 / 1対多 / 多対多の各パターン
  - 子レコードなしの親レコード
  - 孤立レコードケース
3-5. パフォーマンステスト用データの規模を定義する
3-6. 国際化テスト用データを設計する（マルチバイト文字、RTL文字 等）

### 4. データ値の設計方針

4-1. 個人情報に類似しない安全なダミーデータ方針を策定する
4-2. 一意性制約を満たすための命名規則を定義する（`test_user_001` 等）
4-3. 日付データの基準日とオフセット戦略を決定する
4-4. 金額・数量データの現実的な範囲を設定する
4-5. ファクトリパターン（Factory）の活用方針を定義する
4-6. ランダムデータ vs 固定データの使い分けを決定する

### 5. シードスクリプトの仕様策定

5-1. 冪等性（何度実行しても同じ結果）を保証する設計を策定する
5-2. 環境別のデータセット分離を設計する（dev / test / staging）
5-3. データリセット手順（TRUNCATE + 再投入）を定義する
5-4. シードデータのバージョン管理方針を決定する
5-5. 大量データ投入時のバッチ処理戦略を設計する
5-6. 実行ログと検証手順を定義する

### 6. 検証基準の策定

6-1. シード投入後の整合性チェッククエリを設計する
6-2. 外部キー制約違反の検出クエリを準備する
6-3. 必須データの存在確認クエリを準備する
6-4. データ件数の期待値を定義する

## 出力フォーマット

```markdown
# シードデータ設計計画: [対象スキーマ / プロジェクト名]

## 設計サマリ
| 項目 | 内容 |
|------|------|
| 対象テーブル数 | N テーブル |
| 総レコード数（開発環境） | 約 N 件 |
| 総レコード数（パフォーマンステスト） | 約 N 件 |
| 投入フェーズ数 | N フェーズ |
| 冪等性 | 保証する / しない |

## テーブル依存関係グラフ
```
Phase 1 (マスタデータ):
  categories (依存なし)
  roles (依存なし)

Phase 2 (主要エンティティ):
  users → roles
  products → categories

Phase 3 (トランザクションデータ):
  orders → users
  order_items → orders, products

Phase 4 (関連データ):
  reviews → users, products
```

## テーブル別データ設計

### `users` テーブル
| # | 用途 | name | email | role_id | status | deleted_at |
|---|------|------|-------|---------|--------|------------|
| 1 | 正常系:管理者 | テスト管理者 | admin@test.local | 1 | active | NULL |
| 2 | 正常系:一般 | テスト太郎 | user01@test.local | 2 | active | NULL |
| 3 | エッジ:停止 | 停止ユーザ | suspended@test.local | 2 | suspended | NULL |
| 4 | エッジ:削除済 | 削除済ユーザ | deleted@test.local | 2 | active | 2024-01-01 |
| 5 | 境界値:長大名 | ああああ...(255文字) | long@test.local | 2 | active | NULL |
| 6 | 国際化:絵文字 | Test User | intl@test.local | 2 | active | NULL |

### `orders` テーブル
| # | 用途 | user_id | total | status | created_at |
|---|------|---------|-------|--------|------------|
| 1 | 正常系 | 2 | 1500 | completed | 基準日 |
| 2 | エッジ:0円 | 2 | 0 | completed | 基準日-1d |
| 3 | エッジ:未完了 | 2 | 3000 | pending | 基準日 |
| 4 | エッジ:キャンセル | 3 | 500 | cancelled | 基準日-7d |

## データパターン網羅表
| パターン | 対象テーブル | レコード# | 目的 |
|----------|------------|----------|------|
| NULL値 | users | #6 | NULL許容カラムの動作確認 |
| 論理削除 | users | #4 | 削除フィルタの動作確認 |
| 状態遷移 | orders | #1-#4 | 全ステータスパターン |
| 境界値 | users | #5 | VARCHAR上限の動作確認 |
| 親なし子 | - | - | 該当なし（FK制約で防止） |

## データ値の設計方針
| 項目 | 方針 |
|------|------|
| メールアドレス | `*@test.local` ドメインを使用（実在しない） |
| 電話番号 | `090-0000-XXXX` 形式（テスト用番号帯） |
| 住所 | 「テスト県テスト市」等の明らかなダミー |
| 日付 | 基準日: `2024-06-01` からの相対指定 |
| 金額 | 100-100000 の範囲内 |

## 投入スクリプト仕様

### 冪等性の実現方法
```sql
-- UPSERT パターン（PostgreSQL）
INSERT INTO users (id, name, email) VALUES (1, 'テスト管理者', 'admin@test.local')
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, email = EXCLUDED.email;

-- REPLACE パターン（MySQL）
REPLACE INTO users (id, name, email) VALUES (1, 'テスト管理者', 'admin@test.local');
```

### 環境別データセット
| 環境 | データ規模 | 追加データ |
|------|----------|----------|
| dev | 最小限（各テーブル5-10件） | なし |
| test | エッジケース網羅（各テーブル10-20件） | 境界値データ |
| staging | 本番近似（各テーブル1000件+） | パフォーマンスデータ |

## 投入後検証クエリ
```sql
-- 件数確認
SELECT 'users' AS table_name, COUNT(*) AS cnt FROM users
UNION ALL SELECT 'orders', COUNT(*) FROM orders;

-- 外部キー整合性確認
SELECT o.id FROM orders o
LEFT JOIN users u ON o.user_id = u.id WHERE u.id IS NULL;

-- 必須マスタデータ確認
SELECT * FROM roles WHERE id NOT IN (SELECT DISTINCT role_id FROM users);
```
```

## 安全注意

- **絶対に実際の SQL を実行しないこと** -- 本スキルはデータ設計計画の策定のみを行う
- **本番データベースへの接続を行わないこと**
- **実在する個人情報を使用しないこと** -- すべてのデータは明確にダミーであること
- **実在するメールアドレスやドメインを使用しないこと** -- `@test.local` 等を使用する
- **実在する電話番号を使用しないこと** -- テスト用番号帯を使用する
- **本番データからのコピーを推奨しないこと** -- 個人情報漏洩リスクがある
- **シードデータにパスワードのハードコーディングを含めないこと** -- ハッシュ値で記述する
- **クレジットカード番号等のセンシティブデータは含めないこと**

## 終了条件

- 全テーブルの依存関係が整理されていること
- 投入順序がトポロジカルソートで決定されていること
- 正常系・境界値・エッジケースのデータが設計されていること
- データ値の設計方針が明記されていること
- 冪等性を保証するスクリプト仕様が策定されていること
- 環境別のデータセット分離が設計されていること
- 投入後の検証クエリが準備されていること
- 個人情報に類似しないダミーデータ方針が確認されていること
