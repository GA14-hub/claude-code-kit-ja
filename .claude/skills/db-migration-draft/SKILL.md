---
name: db-migration-draft
description: "DBマイグレーションの安全な手順書とロールバック計画を起草する"
argument-hint: "スキーマ変更内容 or マイグレーションファイルパス"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

データベースマイグレーションの安全な実行手順書を起草する。スキーマ変更の影響範囲を分析し、段階的な実行計画とロールバック手順を含む包括的なマイグレーション文書を作成する。本番環境での事故を未然に防ぐことを最優先とする。

## 入力

- 対象テーブル名またはスキーマ変更内容の説明
- 既存のマイグレーションファイル（存在する場合）
- 関連するモデル定義やORMファイル
- 現在のスキーマ定義ファイル（schema.sql, schema.rb, models.py 等）

## 手順

### 1. 現状スキーマの把握

1-1. プロジェクト内のスキーマ定義ファイルを検索する
1-2. 対象テーブルの現在のカラム構成・制約・インデックスを確認する
1-3. 外部キー制約による依存テーブルを洗い出す
1-4. 既存マイグレーション履歴からテーブルの変更経緯を追跡する

### 2. 変更影響の分析

2-1. 変更対象カラムを参照しているクエリをコードベース全体から検索する
2-2. ORM モデル定義で該当カラムを利用している箇所を特定する
2-3. ビュー・ストアドプロシージャ・トリガーへの影響を確認する
2-4. 外部キー制約の連鎖的影響（CASCADE / RESTRICT）を評価する
2-5. 既存データの件数規模を確認し、ロック時間の見積もりに反映する

### 3. マイグレーションSQL の起草

3-1. UP マイグレーション（適用）の SQL を記述する
3-2. DOWN マイグレーション（ロールバック）の SQL を記述する
3-3. デフォルト値・NOT NULL 制約の追加時はデータ充填手順を含める
3-4. 大規模テーブルの場合、pt-online-schema-change 等のオンラインDDL手法を提案する
3-5. マイグレーション実行前の事前チェック SQL を記述する

### 4. ロールバック計画の策定

4-1. ロールバック SQL の正当性を検証する（データ損失がないこと）
4-2. ロールバック判断基準（タイムアウト閾値、エラー率閾値）を定義する
4-3. ロールバック実行時のアプリケーション側の対応手順を記述する
4-4. ロールバック不可能な変更（カラム削除、データ型縮小等）を明示する

### 5. 実行計画の作成

5-1. メンテナンスウィンドウの推奨時間帯を提案する
5-2. 実行前チェックリスト（バックアップ確認、レプリカ遅延確認等）を作成する
5-3. 段階的デプロイ手順（マイグレーション → アプリデプロイ → 検証）を記述する
5-4. 実行後の検証クエリ（データ整合性確認）を記述する

### 6. レビュー観点の整理

6-1. 破壊的変更の有無をサマリとして提示する
6-2. ダウンタイムの発生有無と推定時間を記載する
6-3. チーム内レビューで重点確認すべきポイントを列挙する

## 出力フォーマット

```markdown
# マイグレーション起草: [変更概要]

## 変更サマリ
| 項目 | 内容 |
|------|------|
| 対象テーブル | `table_name` |
| 変更種別 | ADD COLUMN / ALTER COLUMN / DROP TABLE 等 |
| 推定影響行数 | 約 N 行 |
| ダウンタイム | あり（約 N 分） / なし |
| 破壊的変更 | あり / なし |

## 影響範囲
- **参照コード**: `file_path:line` - 変更が必要な箇所の説明
- **依存テーブル**: `related_table` - 外部キー制約の詳細
- **ORM モデル**: `model_file:line` - 更新が必要なモデル定義

## UP マイグレーション
```sql
-- 適用 SQL
BEGIN;
-- DDL statements here
COMMIT;
```

## DOWN マイグレーション（ロールバック）
```sql
-- ロールバック SQL
BEGIN;
-- Rollback DDL statements here
COMMIT;
```

## 事前チェック SQL
```sql
-- 実行前に確認すべきクエリ
SELECT COUNT(*) FROM target_table;
```

## 実行後検証 SQL
```sql
-- 実行後のデータ整合性確認
SELECT column_name, COUNT(*) FROM target_table GROUP BY column_name;
```

## ロールバック計画
| 判断基準 | 閾値 | 対応 |
|----------|------|------|
| 実行時間超過 | N 分以上 | ロールバック実行 |
| エラー率上昇 | N% 以上 | ロールバック実行 |
| データ不整合 | 検出時 | ロールバック実行 |

## 実行チェックリスト
- [ ] データベースバックアップ完了
- [ ] レプリカ遅延 0 秒を確認
- [ ] メンテナンスウィンドウ通知済み
- [ ] ロールバック SQL テスト済み
- [ ] 関連アプリケーションのデプロイ準備完了

## レビュー重点ポイント
1. [確認すべき重要事項]
2. [潜在的リスク]
```

## 安全注意

- **絶対に実際の SQL を実行しないこと** -- 本スキルはドラフト作成のみを行う
- **本番データベースへの接続を行わないこと**
- **DROP / TRUNCATE / DELETE を含む変更は必ずロールバック不可として明示すること**
- **大規模テーブル（100万行超）の ALTER TABLE はオンラインDDL手法を必須とすること**
- **データ型の変更（縮小方向）は暗黙的なデータ損失リスクを必ず警告すること**
- **NOT NULL 制約の追加は既存NULLデータの処理手順を必ず含めること**
- **外部キー制約の変更は参照整合性への影響を必ず分析すること**

## 終了条件

- UP / DOWN 両方のマイグレーション SQL が記述されていること
- 影響を受けるコード箇所がすべて特定されていること
- ロールバック計画に判断基準と手順が含まれていること
- 実行前チェックリストが作成されていること
- 実行後の検証クエリが記述されていること
- 破壊的変更の有無が明示されていること

## このスキルが向かないケース

- **本番環境への直接適用**: 出力されたマイグレーション SQL をそのまま本番に流さないこと。必ず DBA またはチームレビューを経てから実行する
- **スキーマ設計の代替**: 設計判断（正規化レベル、データ型選定）は人間が行うべき。このスキルは「決まった変更の安全な実行方法」を設計するもの
