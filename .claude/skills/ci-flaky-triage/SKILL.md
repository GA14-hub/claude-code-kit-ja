---
name: ci-flaky-triage
description: 不安定なテスト（Flaky Test）を検出・分類し、隔離戦略とリトライ方針を策定する。
argument-hint: "[test-dir|workflow-file|test-log] (任意で疑わしいテスト名)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git log *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

CI で断続的に失敗するテスト（Flaky Test）を体系的に検出し、不安定性の原因を分類する。テストの隔離戦略・リトライ方針・根本修正の優先順位を策定し、CI の信頼性を回復する計画を立てる。

## 入力

- テストディレクトリ、ワークフローファイル、またはテスト実行ログのパス（必須）
- 任意: 不安定と疑われるテスト名やファイル名
- 任意: 「3回に1回失敗する」「朝だけ失敗する」等の発生パターン
- 任意: CI の最近の実行結果へのリンク
- 不足している場合はユーザーに質問する

## 手順

1. **不安定テストの検出**
   - テストログまたはテストディレクトリを Read で読み取る
   - Grep で以下のパターンを検索し、不安定性の兆候を収集する:
     - タイムアウト設定（`setTimeout`、`time.sleep`、`waitFor` 等）
     - 日時依存処理（`Date.now()`、`time.time()`、タイムゾーン参照）
     - ランダム性（`Math.random()`、`random.choice`、シード未固定）
     - 外部サービス依存（HTTP リクエスト、DB 接続、ファイルシステム操作）
     - 共有状態（グローバル変数、共有ファイル、共有 DB テーブル）
     - 実行順序依存（テスト間の暗黙的な依存関係）
   - `git log` で過去のテスト関連の修正履歴を確認し、繰り返し修正されているテストを特定する

2. **不安定性の原因分類**
   - 検出した各テストを以下のカテゴリに分類する:
     - **タイミング依存**: 固定 sleep、タイムアウト値の不足、非同期処理の完了待ち不足
     - **環境依存**: OS 固有の挙動、タイムゾーン、ロケール、ファイルパス
     - **外部依存**: ネットワーク、外部 API、DB 接続、ファイルシステム
     - **状態汚染**: テスト間の共有状態、クリーンアップ漏れ、実行順序依存
     - **リソース競合**: ポート、ファイルロック、並列テスト間の競合
     - **データ依存**: テストデータの不整合、ランダム生成データ、日時依存データ

3. **影響度の評価**
   - 各テストについて以下を評価する:
     - 失敗頻度（高: 3回に1回以上 / 中: 10回に1回 / 低: まれに発生）
     - ブロック影響（CI 全体を止めるか / 特定ジョブだけか）
     - 修正コスト（テストの書き直し / 設定変更 / アーキテクチャ変更）
   - 失敗頻度とブロック影響をもとに対応優先順位を決定する

4. **隔離戦略の策定**
   - 即座に対応が難しいテストの隔離方法を提案する:
     - テストのタグ付けによる分離実行（`@flaky`、`@unstable` タグ）
     - 不安定テスト専用のジョブへの分離
     - `fail-fast: false` による他テストへの影響遮断
   - 隔離したテストの監視方法と、隔離解除の条件を定義する

5. **リトライ方針の設計**
   - プロジェクトのテストフレームワークに応じたリトライ設定を提案する:
     - Jest: `jest.retryTimes()`
     - pytest: `pytest-rerunfailures`
     - Go: `t.Run` + カスタムリトライ
   - リトライ回数の上限、リトライ対象の条件を設定する
   - リトライで合格したテストのログ出力方法を提案する

6. **根本修正計画の作成**
   - 各テストの根本修正方針を具体的に記述する
   - 修正の優先順位を「影響度 x 修正容易さ」で決定する
   - 修正後の検証方法（複数回連続実行、異なる環境での実行）を提案する

## 出力フォーマット

```markdown
## 検出サマリ

- **調査対象**: [テストディレクトリまたはファイル]
- **総テスト数**: [確認したテスト数]
- **不安定テスト候補数**: [検出した候補数]
- **原因カテゴリ分布**: タイミング: X / 環境: X / 外部依存: X / 状態汚染: X

## 不安定テスト一覧

| # | テスト名 | ファイル | 原因カテゴリ | 失敗頻度 | ブロック影響 | 優先度 |
|---|---------|---------|-------------|---------|-------------|-------|
| 1 | [テスト名] | [ファイル:行] | [カテゴリ] | 高/中/低 | 高/低 | P1/P2/P3 |

## 原因詳細

### [テスト名1]

- **原因**: [不安定性の具体的な原因]
- **証拠**: [ログの該当行、コードの該当箇所]
- **根本修正**: [修正方法の具体案]

## 隔離戦略

- **即時隔離対象**: [隔離すべきテストとその方法]
- **隔離方法**: [タグ付け/ジョブ分離/条件付き実行]
- **隔離解除条件**: [根本修正完了 + 連続N回成功]

## リトライ方針

- **フレームワーク**: [使用するリトライ機構]
- **リトライ回数**: [上限回数と理由]
- **対象条件**: [どのテストにリトライを適用するか]
- **設定例**: [具体的な設定コード]

## 修正ロードマップ

| 優先度 | テスト | 修正方針 | 推定工数 |
|-------|--------|---------|---------|
| P1 | [テスト名] | [修正方針] | [目安] |
| P2 | [テスト名] | [修正方針] | [目安] |
```

## 安全注意

- テストコードの変更・削除は行わず、分析と提案のみ行う
- テストの無効化（skip、disable）は隔離戦略として最終手段とし、推奨しない
- リトライ回数の過剰設定（5回以上）は根本原因の隠蔽につながるため警告する
- テストログに含まれる認証情報やテストデータの個人情報は出力に含めない
- `git log` 以外の git 操作は実行しない

## 終了条件

上記の出力フォーマットに従った Flaky Test トリアージ報告を出力したら停止する。不安定テストが原因分類・優先順位付きで一覧化され、隔離戦略・リトライ方針・修正ロードマップが含まれていること。テストの修正はユーザーの指示を待つ。
