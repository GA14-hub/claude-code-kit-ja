---
name: api-error-contract
description: APIのエラーコード体系とエラーレスポンス契約を設計する。一貫性のあるエラーハンドリングを定義する。
argument-hint: "[APIコードベース|エラー仕様ドキュメント|対象ディレクトリ] (任意でエラー種別)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

API のエラーコード体系とエラーレスポンスの契約（コントラクト）を設計する。現行コードベースのエラーハンドリングを分析し、不統一な箇所を特定した上で、クライアントが機械的に処理できる一貫性のあるエラーレスポンス仕様を策定する。RFC 7807（Problem Details for HTTP APIs）を参考に、運用・デバッグ・クライアント実装のすべてで扱いやすいエラー体系を目指す。

## 入力

- API コードベースのディレクトリパスまたはエラーハンドリング関連ファイル（必須）
- 既存のエラー仕様ドキュメント（任意）
- 重点的に設計したいエラー種別（任意: バリデーション、認証、ビジネスロジック等）
- 利用しているフレームワーク情報（任意）
- 不足している場合はユーザーに質問する

## 手順

1. **現行エラーハンドリングの棚卸し**
   - Grep でエラーレスポンスの返却箇所を検索する（`res.status`、`HttpException`、`raise`、`abort` 等）
   - エラーレスポンスのフォーマットを収集し、パターンを分類する
   - ステータスコードの使い方に不統一がないか確認する（例: 400 と 422 の混在）
   - エラーメッセージの国際化対応状況を把握する
   - エラーログとエラーレスポンスの紐付け方法を確認する

2. **エラー分類体系の設計**
   - エラーを大分類する: クライアントエラー（4xx）、サーバーエラー（5xx）
   - 中分類を設計する: バリデーション、認証、認可、リソース、ビジネスロジック、レート制限、システム
   - 各分類にエラーコードのプレフィックスを割り当てる（例: `AUTH_001`、`VALIDATION_002`）
   - コード体系の拡張性を確保する（将来の追加を見越した番号帯の確保）

3. **エラーレスポンス構造の定義**
   - 共通エラーレスポンスのスキーマを設計する
   - 必須フィールド: エラーコード、メッセージ、HTTP ステータス
   - 任意フィールド: 詳細情報、対象フィールド、トレースID、ドキュメントリンク
   - バリデーションエラーはフィールド単位のエラー配列を含める
   - 複数エラーの同時返却方針を定める

4. **HTTP ステータスコードのマッピングルール策定**
   - エラー分類と HTTP ステータスコードの対応表を作成する
   - 曖昧になりがちなケースの判断基準を明文化する
     - 400 vs 422: 構文エラー vs セマンティックエラー
     - 401 vs 403: 認証失敗 vs 認可失敗
     - 404 vs 410: 未存在 vs 削除済み
     - 409 vs 422: 競合 vs ビジネスルール違反
   - サーバーエラー（500/502/503/504）の使い分け方針を定める

5. **クライアント向けエラーハンドリングガイドの設計**
   - エラーコード別のクライアント推奨アクション（リトライ、再認証、ユーザー通知等）を定義する
   - リトライ可能なエラーとリトライ不可のエラーを明確に区分する
   - `Retry-After` ヘッダー等のリトライ制御情報の提供方針を定める
   - エラーメッセージのユーザー表示可否を定義する（技術的メッセージ vs ユーザー向けメッセージ）

6. **既存コードとのギャップ分析**
   - 現行のエラーハンドリングと設計したコントラクトの差異を一覧化する
   - 移行の優先度を判定する（破壊的変更 vs 追加対応）
   - 段階的な移行手順の概要を作成する

## 出力フォーマット

```markdown
## エラーコントラクト設計書

### 設計原則
- **準拠規格**: [例: RFC 7807 Problem Details ベース]
- **コード体系**: [例: `{カテゴリ}_{連番3桁}` 形式]
- **国際化方針**: [例: コードで機械処理、メッセージは参考情報]

### エラーレスポンス共通構造

```json
{
  "error": {
    "code": "VALIDATION_001",
    "message": "入力値が不正です",
    "status": 400,
    "details": [...],
    "trace_id": "abc-123",
    "doc_url": "https://docs.example.com/errors/VALIDATION_001"
  }
}
```

### バリデーションエラー構造

```json
{
  "error": {
    "code": "VALIDATION_001",
    "message": "入力値に問題があります",
    "status": 422,
    "details": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "メールアドレスの形式が正しくありません"
      }
    ]
  }
}
```

### エラーコード一覧

| コード | HTTP ステータス | 分類 | 説明 | リトライ可 | クライアント推奨アクション |
|--------|---------------|------|------|-----------|----------------------|
| AUTH_001 | 401 | 認証 | トークン期限切れ | Yes | トークン再取得 |
| AUTH_002 | 401 | 認証 | トークン不正 | No | 再ログイン |
| AUTH_003 | 403 | 認可 | 権限不足 | No | 権限確認を促す |
| VALIDATION_001 | 422 | バリデーション | 入力値不正 | No | フィールド修正 |
| RESOURCE_001 | 404 | リソース | 対象未発見 | No | ID確認 |
| RATE_001 | 429 | レート制限 | リクエスト超過 | Yes | Retry-After 待機 |
| SYSTEM_001 | 500 | システム | 内部エラー | Yes | 時間をおいて再試行 |

### HTTP ステータスコード判断基準

| 状況 | ステータス | 判断理由 |
|------|-----------|---------|
| [JSON パース不可] | [400] | [構文レベルのエラー] |
| [必須フィールド欠落] | [422] | [セマンティックバリデーション] |
| [認証トークンなし] | [401] | [認証情報の欠如] |
| [権限のない操作] | [403] | [認証済みだが認可されていない] |

### 既存コードとのギャップ

| 箇所 | 現状 | あるべき姿 | 影響度 | 移行優先度 |
|------|------|-----------|-------|-----------|
| [ファイル:行] | [現状の実装] | [設計した仕様] | [高/中/低] | [P1/P2/P3] |

### 移行ロードマップ

1. **Phase 1**: [共通エラーハンドラーの実装]
2. **Phase 2**: [既存エンドポイントの段階的移行]
3. **Phase 3**: [クライアントSDKの更新]
```

## 安全注意

- エラーレスポンスにスタックトレースや内部実装の詳細を露出しない設計にする
- サーバーエラー時にデータベースのテーブル名やカラム名がメッセージに含まれないよう注意する
- エラーコードの設計のみを行い、コードの変更は実施しない
- セキュリティ関連エラー（認証・認可）では情報漏洩に繋がる詳細メッセージを避ける設計にする
- 既存クライアントに影響するエラーフォーマット変更は破壊的変更として明示する

## 終了条件

上記の出力フォーマットに従ったエラーコントラクト設計書を出力したら停止する。エラーコードが分類体系に基づいて網羅的に定義され、HTTP ステータスコードの判断基準とクライアント向けガイドが記載されていること。実装作業はユーザーの指示を待つ。
