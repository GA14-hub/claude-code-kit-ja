---
name: ops-alert-design
description: アラート閾値の設計、ノイズ削減、エスカレーションフローを体系的に設計する。アラート疲れを防ぎつつ重要な異常を見逃さない。
argument-hint: "[サービス名 or コードベースのパス] (任意で既存アラート設定ファイルのパス)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

対象システムのコードベースと既存設定を分析し、アラートルールを設計する。閾値の根拠を明確にし、ノイズとなる誤報を削減する仕組みを組み込み、深刻度に応じたエスカレーションフローを定義する。「鳴るべきときに鳴り、鳴らないでいいときに黙る」アラートを目指す。

## 入力

- 対象サービス名またはコードベースのパス（必須）
- 任意: 既存のアラート設定ファイル（Prometheus alerting rules、CloudWatch alarms 等）のパス
- 任意: 既知のノイズアラート（頻繁に発火して無視されているもの）
- 任意: SLO/SLA の定義
- 任意: オンコール体制の情報（チーム規模、時間帯）
- 不足している場合はユーザーに質問する

## 手順

1. **現状の把握**
   - Glob でアラート関連の設定ファイルを検索する（`alerts/`、`*.rules.yml`、`alarms.tf` 等）
   - Read で既存アラートルールの内容を確認する
   - Grep でアラート関連のコードを検索する（`alert`、`notification`、`pager`、`oncall`）
   - 既存アラートの一覧と現在の閾値を整理する

2. **アラート分類の設計**
   - アラートを以下の 3 層に分類する:
     - **P1（即時対応）**: ユーザー影響あり、サービス停止レベル
     - **P2（当日対応）**: 機能劣化、パフォーマンス低下
     - **P3（計画対応）**: 予兆検知、キャパシティ警告
   - 各分類にどのメトリクスが該当するかを整理する

3. **閾値の設計**
   - 静的閾値: 明確な上限/下限がある指標（エラー率、ディスク使用率 等）
   - 変化率閾値: 急激な変動を検知する指標（リクエスト数の急減/急増）
   - バーンレート閾値: SLO に基づくエラーバジェット消費速度
   - 各閾値に「なぜその値か」の根拠を付記する

4. **ノイズ削減の設計**
   - 発火条件の工夫: 連続 N 分超過（for 句）でフラッピング防止
   - グルーピング: 同一原因のアラートを集約するルール
   - 抑制（inhibition）: 上位アラートが発火中は下位アラートを抑制
   - メンテナンスウィンドウ: デプロイ中の一時的なアラート無効化手順

5. **エスカレーションフローの設計**
   - P1: 即時通知 → 応答なし N 分で二次通知 → さらに N 分でマネージャー通知
   - P2: チームチャンネル通知 → 営業時間内に対応
   - P3: ダッシュボード表示 + 日次サマリ
   - 通知先（Slack / PagerDuty / メール）を深刻度別に整理する

## 出力フォーマット

```markdown
## アラート設計サマリ

- **対象サービス**: [サービス名]
- **既存アラート数**: [N 件（うちノイズ疑い M 件）]
- **設計方針**: [SLO ベース / 閾値ベース / ハイブリッド]

## アラートルール一覧

### P1（即時対応）

| アラート名 | メトリクス | 条件 | 持続時間 | 根拠 | 通知先 |
|-----------|----------|------|---------|------|--------|
| [名前] | [メトリクス] | [> 閾値] | [N 分] | [根拠] | [通知先] |

### P2（当日対応）

| アラート名 | メトリクス | 条件 | 持続時間 | 根拠 | 通知先 |
|-----------|----------|------|---------|------|--------|
| [名前] | [メトリクス] | [> 閾値] | [N 分] | [根拠] | [通知先] |

### P3（計画対応）

| アラート名 | メトリクス | 条件 | 持続時間 | 根拠 | 通知先 |
|-----------|----------|------|---------|------|--------|
| [名前] | [メトリクス] | [> 閾値] | [N 分] | [根拠] | [通知先] |

## ノイズ削減策

| 手法 | 対象アラート | 設定内容 | 期待効果 |
|------|------------|---------|---------|
| 持続時間条件 | [対象] | for: [N]m | フラッピング防止 |
| グルーピング | [対象] | group_by: [ラベル] | 通知件数削減 |
| 抑制 | [対象] | [上位アラート] 発火時に抑制 | 重複通知防止 |

## エスカレーションフロー

### P1 フロー
[フローチャート（テキスト形式）]

### P2/P3 フロー
[フローチャート（テキスト形式）]

## 既存アラートの改善提案

| 既存アラート | 現在の問題 | 改善案 |
|------------|----------|--------|
| [アラート名] | [ノイズ / 閾値不適切 / 通知先不適切] | [改善内容] |
```

## 安全注意

- アラート設定ファイルの変更は一切行わない（設計と提案のみ）
- 既存の P1 アラートを安易に無効化する提案は行わない
- 閾値の推奨値は一般的な目安であり、実運用データに基づく調整が必要であることを明記する
- 通知先にメールアドレスや電話番号などの個人情報を含めない
- オンコール体制に無理のないエスカレーション設計を心がける

## 終了条件

上記の出力フォーマットに従ったアラート設計レポートを出力したら停止する。深刻度別のアラートルール、ノイズ削減策、エスカレーションフロー、既存アラートの改善提案が含まれていること。設定の適用はユーザーの指示を待つ。
