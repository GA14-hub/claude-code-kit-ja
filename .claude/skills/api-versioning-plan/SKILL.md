---
name: api-versioning-plan
description: API のバージョン移行計画を策定する。v1からv2への互換性維持・段階的リリース・クライアント移行を設計する。
argument-hint: "[APIコードベース|OpenAPI仕様|変更要件] (任意で移行期限)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

API のメジャーバージョンアップ（例: v1 → v2）に伴う移行計画を策定する。既存クライアントへの影響を最小化しながら、破壊的変更を安全に導入するための段階的リリース計画・互換性維持方針・クライアント移行支援策を設計する。並行稼働期間の運用方針やバージョン廃止のタイムラインも含めた包括的な移行計画を作成する。

## 入力

- API コードベースまたは OpenAPI 仕様ファイル（必須）
- 新バージョンで導入したい変更の要件（必須）
- 移行期限やスケジュール制約（任意）
- 現在のクライアント数・種別の情報（任意）
- 現行のバージョニング方式（任意: URL パス/ヘッダー/クエリパラメータ）
- 不足している場合はユーザーに質問する

## 手順

1. **現行バージョンの分析**
   - Glob でルーティング定義やコントローラーを検索し、現行の API 構造を把握する
   - 現行のバージョニング方式（URL パス `/v1/`、ヘッダー `Accept-Version`、クエリ `?version=1` 等）を確認する
   - Grep でバージョン関連のミドルウェアやルーティング処理を特定する
   - 現行バージョンのエンドポイント一覧を作成する
   - 共通ロジック（認証、バリデーション、シリアライゼーション等）のバージョン依存度を調査する

2. **変更要件の整理と分類**
   - 新バージョンで導入する変更を列挙する
   - 各変更を以下に分類する:
     - 破壊的変更（既存クライアントが動かなくなる）
     - 非推奨化（旧機能を残しつつ新機能を推奨）
     - 新規追加（後方互換な新機能）
   - 変更間の依存関係を整理する（変更Aなしに変更Bは不可能 等）
   - 変更の優先度と技術的難易度を評価する

3. **バージョニング戦略の設計**
   - プロジェクトに最適なバージョニング方式を選定する:
     - URL パスベース（`/v1/` → `/v2/`）: 最も明確、キャッシュ容易
     - カスタムヘッダー（`API-Version: 2`）: URL がきれい、CDN で扱いにくい
     - Content Negotiation（`Accept: application/vnd.api.v2+json`）: REST 的に正しい
   - 新旧バージョンのコード共有戦略を設計する:
     - 共通ロジックの抽出とバージョン分岐の方法
     - コントローラー/ハンドラーの分離方針
     - モデル/スキーマの互換性レイヤー

4. **段階的リリース計画の策定**
   - リリースをフェーズに分割する:
     - **準備フェーズ**: コード共有基盤の整備、v2 の開発環境構築
     - **ベータフェーズ**: v2 の限定公開（特定クライアントへの先行提供）
     - **並行稼働フェーズ**: v1 と v2 の同時稼働、クライアント移行期間
     - **非推奨フェーズ**: v1 に非推奨マークを付与、移行督促
     - **廃止フェーズ**: v1 の停止、リダイレクトまたはエラー返却
   - 各フェーズの期間と開始条件・終了条件を定義する
   - 各フェーズでのロールバック方針を明記する

5. **クライアント移行支援策の設計**
   - 移行ガイドの構成を設計する（エンドポイント対応表、コード例、FAQ）
   - 互換性レイヤーの設計: 旧リクエストを新仕様に変換するアダプター
   - Deprecation ヘッダー（`Sunset`、`Deprecation`）の導入方針
   - クライアントへの通知計画（メール、チャンジログ、ダッシュボード通知等）
   - 移行状況のモニタリング方法（v1/v2 別のリクエスト数追跡等）

6. **リスク評価と緩和策**
   - 移行に伴うリスクを列挙し、緩和策を定める
   - 並行稼働期間中のデータ整合性リスクを評価する
   - パフォーマンスへの影響（2バージョン同時稼働のリソース増）を見積もる
   - 移行が計画通り進まない場合の対応策を策定する

## 出力フォーマット

```markdown
## API バージョニング移行計画書

### 基本情報
- **現行バージョン**: [v1]
- **新バージョン**: [v2]
- **バージョニング方式**: [選定した方式と理由]
- **並行稼働期間**: [推奨期間]
- **v1 廃止予定**: [予定時期]

### 変更一覧

| # | 変更内容 | 分類 | 優先度 | 難易度 | 依存 |
|---|---------|------|-------|-------|------|
| 1 | [変更内容] | 破壊的/非推奨化/新規 | P1/P2/P3 | 高/中/低 | なし/# |

### バージョニング戦略

#### 方式選定
- **採用方式**: [方式名]
- **選定理由**: [理由]
- **URL 構造**: [例: `/api/v1/...` → `/api/v2/...`]

#### コード共有方針
- **共通ロジック**: [共有方法]
- **バージョン分岐**: [分岐方法]
- **テスト戦略**: [v1/v2 両方のテスト実行方法]

### 段階的リリース計画

#### Phase 0: 準備（推奨: X週間）
- **目的**: [この段階の目的]
- **作業内容**:
  - [ ] [具体的な作業項目]
  - [ ] [具体的な作業項目]
- **完了条件**: [次のフェーズに進む条件]
- **ロールバック**: [問題時の対応]

#### Phase 1: ベータ公開（推奨: X週間）
- **目的**: [この段階の目的]
- **作業内容**:
  - [ ] [具体的な作業項目]
- **完了条件**: [次のフェーズに進む条件]
- **ロールバック**: [問題時の対応]

#### Phase 2: 並行稼働（推奨: X週間）
- **目的**: [この段階の目的]
- **作業内容**:
  - [ ] [具体的な作業項目]
- **完了条件**: [次のフェーズに進む条件]
- **ロールバック**: [問題時の対応]

#### Phase 3: 非推奨化（推奨: X週間）
- **通知方針**: [クライアントへの通知方法]
- **ヘッダー設定**: `Sunset: [日付]`, `Deprecation: true`
- **モニタリング**: [v1 利用状況の追跡方法]

#### Phase 4: 廃止
- **廃止条件**: [v1 を停止する判断基準]
- **停止後の挙動**: [410 Gone / リダイレクト / エラーメッセージ]

### クライアント移行ガイド（概要）

#### エンドポイント対応表

| v1 | v2 | 変更点 |
|----|-----|-------|
| [v1 のパス] | [v2 のパス] | [変更の要約] |

#### 移行コード例
```
[v1 → v2 の移行コード例の構成案]
```

### リスク評価

| リスク | 影響度 | 発生確率 | 緩和策 |
|-------|-------|---------|--------|
| [リスク内容] | 高/中/低 | 高/中/低 | [緩和策] |

### モニタリング項目

| 指標 | 計測方法 | 閾値 | アクション |
|------|---------|------|-----------|
| v1 リクエスト数推移 | [方法] | [閾値] | [閾値超過時の対応] |
| v2 エラー率 | [方法] | [閾値] | [閾値超過時の対応] |
```

## 安全注意

- 移行計画書の作成のみを行い、バージョニングの実装やコード変更は実施しない
- 並行稼働期間中のデータ整合性リスクを必ず明記する
- v1 の即時廃止は推奨しない。最低でも非推奨期間を設ける方針で計画する
- クライアントへの影響が大きい変更は段階的に導入する方針を堅持する
- 移行計画にはロールバック手順を必ず含める

## 終了条件

上記の出力フォーマットに従った移行計画書を出力したら停止する。すべての変更が分類され、段階的リリース計画にフェーズごとの作業・完了条件・ロールバック方針が記載されていること。実装作業はユーザーの指示を待つ。
