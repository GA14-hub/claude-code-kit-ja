---
name: ci-workflow-fix
description: CI の失敗ログを分析し、原因特定と修正案を提示する。キャッシュ・並列実行・権限問題に対応。
argument-hint: "[log-file|workflow-url|error-message] (任意で失敗ジョブ名)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git *), Bash(cat *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

CI パイプラインの失敗ログを体系的に分析し、根本原因を特定する。キャッシュ破損・並列実行の競合・権限不足・依存関係の不整合・環境差異など、頻出するCI障害パターンに基づいて原因を切り分け、具体的な修正案を提示する。

## 入力

- CI の失敗ログファイルのパス、ワークフロー URL、またはエラーメッセージ（必須）
- 任意: 失敗しているジョブ名やステップ名
- 任意: 直近で変更したファイルや設定の情報
- 任意: 「たまに失敗する」「特定ブランチのみ」等の再現条件
- 不足している場合はユーザーに質問する

## 手順

1. **ログの読み取りと構造化**
   - 指定されたログファイルまたはエラーメッセージを Read で読み取る
   - ログからエラー行、警告行、失敗したステップ名を抽出する
   - タイムスタンプがある場合、各ステップの所要時間と失敗タイミングを把握する
   - 終了コード、エラーコード、例外メッセージを分類する

2. **障害パターンの照合**
   - 抽出したエラー情報を以下の頻出パターンと照合する:
     - **キャッシュ問題**: キャッシュキーの不一致、キャッシュの破損、ロックファイルの不整合
     - **並列実行の競合**: ポートの衝突、ファイルロック、DB アクセスの競合
     - **権限問題**: `GITHUB_TOKEN` のスコープ不足、ファイル権限、コンテナ内の権限
     - **依存関係**: バージョン解決の失敗、非互換バージョン、レジストリ障害
     - **環境差異**: Node/Python バージョンの不一致、OS 固有の問題、パス区切り文字
     - **タイムアウト**: テスト実行の遅延、外部サービスの応答遅延、リソース不足

3. **ワークフローファイルとの突合**
   - `.github/workflows/` ディレクトリのワークフローファイルを Glob で検索し Read で読み取る
   - 失敗したステップの設定内容（キャッシュキー、環境変数、条件分岐）を確認する
   - 直近の `git log` で `.github/workflows/` の変更履歴を確認し、障害との関連を調べる

4. **関連コードの変更確認**
   - `git diff` で直近の変更内容を確認し、CI 失敗との因果関係を調べる
   - ロックファイル（`package-lock.json`、`poetry.lock` 等）の変更有無を確認する
   - テスト設定ファイルや CI 関連の設定ファイルの変更を確認する

5. **原因特定と修正案の作成**
   - 照合結果から最も可能性の高い原因を特定し、根拠を明示する
   - ワークフローファイルの修正が必要な場合、修正前後の diff を提示する
   - 恒久対策（再発防止策）と暫定対策（一時的な回避策）を分けて提示する

6. **再実行戦略の提案**
   - 修正適用後の検証方法を提案する
   - 同様の失敗を早期検知するためのモニタリング案を提示する

## 出力フォーマット

```markdown
## 障害概要

- **失敗ワークフロー**: [ワークフロー名]
- **失敗ジョブ/ステップ**: [ジョブ名 > ステップ名]
- **エラーメッセージ**: [主要なエラーメッセージ]
- **障害パターン**: [キャッシュ/並列実行/権限/依存関係/環境差異/タイムアウト]

## 原因分析

### 根本原因

[原因の説明と、そう判断した根拠]

### 関連する変更

| ファイル | 変更内容 | 障害との関連 |
|---------|---------|-------------|
| [ファイルパス] | [変更概要] | [関連の説明] |

## 修正案

### 恒久対策（推奨）

[ワークフロー修正の diff または設定変更の具体的内容]

### 暫定対策（急ぎの場合）

[一時的な回避策]

## 再発防止

- [ ] [再発防止策1]
- [ ] [再発防止策2]

## 検証手順

1. [修正適用後の確認手順]
2. [CI の再実行と結果確認方法]
```

## 安全注意

- ログに含まれるトークン・シークレット・認証情報は出力に含めない（マスクする）
- ワークフローファイルの直接編集は行わず、修正案の提示のみ行う
- `git push`、`git reset` 等の破壊的な git 操作は実行しない
- 本番環境のデプロイワークフローに関する修正案は、特にリスクを明記する
- ログファイルに個人情報が含まれる場合はマスクして出力する

## 終了条件

上記の出力フォーマットに従った障害分析レポートを出力したら停止する。根本原因が根拠付きで特定され、修正案（恒久・暫定）と検証手順が含まれていること。ワークフローファイルの修正はユーザーの指示を待つ。
