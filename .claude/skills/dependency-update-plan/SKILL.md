---
name: dependency-update-plan
description: 依存パッケージの更新影響を分析し、安全な更新順序と計画を策定する。
argument-hint: "[project-dir|package-file] (任意で対象パッケージ名)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(npm outdated *), Bash(pip list *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

プロジェクトの依存パッケージの更新状況を分析し、更新による影響範囲・破壊的変更のリスク・更新の優先順位を評価する。安全な更新順序を策定し、段階的に依存関係を最新状態に近づける計画を作成する。

## 入力

- プロジェクトディレクトリまたはパッケージ管理ファイルのパス（必須）
- 任意: 特定のパッケージ名（そのパッケージに焦点を当てた分析）
- 任意: 更新の動機（セキュリティ脆弱性、新機能の利用、EOL 対応等）
- 任意: 更新を避けたいパッケージとその理由
- 不足している場合はユーザーに質問する

## 手順

1. **依存関係の現状把握**
   - パッケージ管理ファイルを Read で読み取る:
     - Node.js: `package.json`、`package-lock.json` / `yarn.lock` / `pnpm-lock.yaml`
     - Python: `pyproject.toml`、`requirements.txt`、`poetry.lock` / `Pipfile.lock`
     - Go: `go.mod`、`go.sum`
   - 利用可能な場合、パッケージマネージャで更新可能なパッケージを確認する:
     - `npm outdated --json`（Node.js）
     - `pip list --outdated --format=json`（Python）
   - 依存パッケージの総数、直接依存と間接依存の比率を把握する

2. **更新対象の分類と優先順位付け**
   - 更新可能なパッケージを以下の基準で分類する:
     - **セキュリティ修正**: 既知の脆弱性（CVE）が修正されているバージョン
     - **破壊的変更（メジャー）**: API の変更を伴うメジャーバージョンアップ
     - **機能追加（マイナー）**: 後方互換性のある機能追加
     - **バグ修正（パッチ）**: 後方互換性のあるバグ修正
   - 各パッケージの更新優先度を以下で評価する:
     - セキュリティリスクの有無（高優先）
     - EOL / 非推奨の状態（高優先）
     - プロジェクトでの利用範囲の広さ（広いほど慎重に）
     - 更新のリスク（破壊的変更の大きさ）

3. **影響範囲の分析**
   - 各パッケージがプロジェクト内のどこで使われているかを Grep で検索する
   - `import`、`require`、`from ... import` の検索で直接利用箇所を特定する
   - パッケージが提供する API のうち、プロジェクトで使用しているものを列挙する
   - メジャーバージョンアップの場合、変更ログ（CHANGELOG）から破壊的変更の内容を確認する

4. **依存関係の衝突チェック**
   - パッケージ間の依存関係を確認し、更新時に衝突が発生しないかを検証する:
     - peer dependency の要件
     - バージョン範囲の制約
     - 同一パッケージの複数バージョン共存の可否
   - 連鎖的に更新が必要なパッケージを特定する
   - ロックファイルの再生成が必要なケースを把握する

5. **安全な更新順序の策定**
   - 以下の原則に基づいて更新順序を決定する:
     - パッチ更新 → マイナー更新 → メジャー更新の順
     - 依存されている側のパッケージを先に更新する
     - テストで検証しやすいパッケージを先に更新する
     - セキュリティ修正は最優先
   - 更新をグループ化し、1回のPRで行える単位にまとめる
   - 各グループの更新後に実行すべきテスト・検証手順を記載する

6. **更新計画の文書化**
   - 段階的な更新スケジュールを作成する
   - 各段階のロールバック手順を明記する
   - Dependabot / Renovate の設定が有効な場合、自動更新との整合性を確認する
   - 更新後の動作確認チェックリストを作成する

## 出力フォーマット

```markdown
## 依存関係の現状

- **パッケージマネージャ**: [npm/yarn/pip/poetry/go mod]
- **直接依存数**: [N個]
- **間接依存数**: [N個（判明している場合）]
- **更新可能なパッケージ数**: [N個]
- **ロックファイル**: [あり/なし]

## 更新対象一覧

| # | パッケージ | 現在 | 最新 | 種別 | 優先度 | リスク |
|---|-----------|------|------|------|-------|-------|
| 1 | [名前] | [現バージョン] | [最新バージョン] | セキュリティ | P1 | 低 |
| 2 | [名前] | [現バージョン] | [最新バージョン] | メジャー | P2 | 高 |
| 3 | [名前] | [現バージョン] | [最新バージョン] | マイナー | P3 | 低 |
| 4 | [名前] | [現バージョン] | [最新バージョン] | パッチ | P3 | 低 |

## 影響分析

### [パッケージ名1]（メジャー更新）

- **利用箇所**: [ファイル数と主な利用パターン]
- **破壊的変更**: [変更内容の概要]
- **必要な修正**: [コード修正が必要な箇所と内容]
- **推定工数**: [修正にかかる目安時間]

## 依存関係の衝突

| パッケージA | パッケージB | 衝突内容 | 解決方法 |
|-----------|-----------|---------|---------|
| [名前] | [名前] | [衝突の内容] | [解決方法] |

## 更新計画

### グループ1: セキュリティ修正（最優先）

- **対象**: [パッケージ一覧]
- **更新コマンド**: [実行コマンド]
- **検証手順**: [テスト・確認手順]
- **ロールバック**: [戻し方]

### グループ2: パッチ・マイナー更新（低リスク）

- **対象**: [パッケージ一覧]
- **更新コマンド**: [実行コマンド]
- **検証手順**: [テスト・確認手順]

### グループ3: メジャー更新（要注意）

- **対象**: [パッケージ一覧]
- **事前準備**: [コード修正、テスト追加等]
- **更新手順**: [段階的な更新手順]
- **検証手順**: [テスト・確認手順]
- **ロールバック**: [戻し方]

## 自動化設定

- **Dependabot / Renovate**: [現在の設定状況と推奨設定]
- **自動マージ条件**: [パッチ更新の自動マージ基準]
- **更新頻度**: [推奨する更新チェック頻度]

## 更新後チェックリスト

- [ ] 全テストがパスする
- [ ] ビルドが成功する
- [ ] ロックファイルが正しく更新されている
- [ ] 型チェック・リンターがパスする
- [ ] 主要機能の動作確認が完了している
```

## 安全注意

- パッケージの実際の更新（`npm install`、`pip install` 等）は実行せず、計画の出力のみ行う
- `npm outdated` と `pip list --outdated` は読み取り専用コマンドとして安全に実行する
- セキュリティ脆弱性の詳細な攻撃手法は出力に含めない（CVE 番号と概要のみ）
- ロックファイルの削除や再生成は計画に含めるが、実行はユーザーの判断に委ねる
- プライベートレジストリの認証情報を出力に含めない
- 依存パッケージのライセンス変更がある場合は警告する

## 終了条件

上記の出力フォーマットに従った依存更新計画を出力したら停止する。更新対象一覧（優先度・リスク付き）、影響分析、更新順序、グループ別の更新手順、チェックリストが含まれていること。パッケージの更新実行はユーザーの指示を待つ。
