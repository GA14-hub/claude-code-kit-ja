---
name: db-schema-review
description: "命名規則・正規化・制約・削除ポリシーの観点からスキーマをレビューする"
argument-hint: "スキーマ定義ファイルパス or マイグレーションディレクトリ"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 実行モード

- **簡易モード**（デフォルト）: 手順1（命名規則）、3（制約設計）、6（総合評価）のみ実行し、主要な問題点と改善案を返す
- **詳細モード**: `--detailed` を引数に追加すると、全6手順を実行しパフォーマンス考慮・削除ポリシーを含む包括的なレビューを返す

$ARGUMENTS に `--detailed` が含まれていない場合は簡易モードで実行する。簡易モードでは出力フォーマットの該当セクションのみ出力する。

## 目的

データベーススキーマを命名規則、正規化水準、制約設計、削除ポリシーの4軸で包括的にレビューする。データの整合性・保守性・拡張性を担保するための改善点を体系的に報告する。

## 入力

- スキーマ定義ファイル（schema.sql, schema.rb, models.py, schema.prisma 等）
- マイグレーションファイル群
- ORM モデル定義ファイル
- ER図 定義ファイル（任意）

## 手順

### 1. 命名規則の検査

1-1. テーブル名の命名規則を確認する（単数形/複数形の統一、snake_case の使用）
1-2. カラム名の命名規則を確認する（プレフィックス・サフィックスの統一性）
1-3. 主キー・外部キーの命名パターンを確認する（`id`, `table_id` の統一）
1-4. インデックス名の命名規則を確認する（`idx_table_column` パターン）
1-5. 予約語との衝突を検出する（`order`, `user`, `group`, `key` 等）
1-6. 略語の一貫性を確認する（`num` vs `number`, `qty` vs `quantity` 等）
1-7. Boolean カラムの命名を確認する（`is_`, `has_`, `can_` プレフィックス）

### 2. 正規化水準の評価

2-1. 第1正規形の違反を検出する（カンマ区切り値、JSON配列での複数値格納）
2-2. 第2正規形の違反を検出する（部分関数従属）
2-3. 第3正規形の違反を検出する（推移的関数従属）
2-4. 意図的な非正規化箇所を特定し、妥当性を評価する
2-5. 非正規化している場合のデータ同期メカニズムを確認する
2-6. 多対多リレーションの中間テーブル設計を評価する

### 3. 制約設計の検査

3-1. 全テーブルの主キー設計を確認する（自然キー vs サロゲートキー）
3-2. NOT NULL 制約の適切性を評価する（必須項目に付与されているか）
3-3. UNIQUE 制約の必要箇所を確認する（ビジネスキーの一意性保証）
3-4. 外部キー制約の設定を確認する（リレーション列への制約付与）
3-5. CHECK 制約の活用を確認する（値の範囲制限、ENUM 代替）
3-6. DEFAULT 値の設定を確認する（タイムスタンプ、ステータス初期値）
3-7. カラムのデータ型の適切性を評価する（VARCHAR 長、数値型の精度）
3-8. NULL許容カラムの妥当性を確認する（本当にNULLが必要なケース）

### 4. 削除ポリシーの評価

4-1. 物理削除と論理削除の使い分けを確認する
4-2. 論理削除カラム（`deleted_at`, `is_deleted`）の設計を評価する
4-3. 論理削除レコードの UNIQUE 制約への影響を確認する
4-4. CASCADE DELETE の設定と影響範囲を分析する
4-5. 孤立レコード（親なし子レコード）の発生可能性を評価する
4-6. データ保持期間ポリシーとアーカイブ戦略を確認する
4-7. GDPR / 個人情報削除要件への対応状況を確認する

### 5. 拡張性とパフォーマンスの考慮

5-1. テーブル分割の必要性を評価する（水平分割・垂直分割）
5-2. 将来的な要件変更に対する柔軟性を評価する
5-3. タイムスタンプカラム（created_at, updated_at）の設計を確認する
5-4. ポリモーフィックリレーションの適切性を評価する
5-5. ENUM 型 vs 参照テーブルの使い分けを確認する

### 6. 総合評価の作成

6-1. 各検査軸ごとのスコアを算出する（A / B / C / D）
6-2. 優先度付きの改善提案を作成する
6-3. スキーマ全体の健全性を総合判定する

## 出力フォーマット

```markdown
# スキーマレビュー: [プロジェクト / データベース名]

## 総合評価
| 検査軸 | 評価 | 主な指摘事項 |
|--------|------|-------------|
| 命名規則 | A / B / C / D | [概要] |
| 正規化 | A / B / C / D | [概要] |
| 制約設計 | A / B / C / D | [概要] |
| 削除ポリシー | A / B / C / D | [概要] |
| 拡張性 | A / B / C / D | [概要] |

**評価基準**: A=優良 / B=良好（軽微な改善推奨） / C=要改善 / D=重大な問題あり

## 命名規則

### 検出された不統一
| 箇所 | 現状 | 推奨 | 理由 |
|------|------|------|------|
| `table_name.columnName` | camelCase | `column_name` (snake_case) | プロジェクト規約との不統一 |
| `tbl_users` | プレフィックス付き | `users` | 不要なプレフィックスは冗長 |

### 予約語衝突
| テーブル/カラム | 予約語 | 推奨代替名 |
|---------------|--------|-----------|
| `order` | SQL予約語 | `orders` / `purchase_order` |

## 正規化

### 正規化違反
| テーブル | カラム | 違反種別 | 説明 | 改善案 |
|----------|--------|---------|------|--------|
| `users` | `tags` | 第1正規形 | カンマ区切りで複数値格納 | `user_tags` 中間テーブルに分離 |

### 意図的な非正規化
| テーブル | カラム | 目的 | 同期手法 | 評価 |
|----------|--------|------|---------|------|
| `orders` | `user_name` | 結合コスト削減 | トリガー | 妥当 / 要検討 |

## 制約設計

### 不足している制約
| テーブル | カラム | 推奨制約 | 理由 |
|----------|--------|---------|------|
| `users` | `email` | UNIQUE | ビジネスキーとして一意性が必要 |
| `orders` | `status` | CHECK | 許容値の範囲制限が必要 |
| `items` | `category_id` | FOREIGN KEY | 参照整合性の保証が必要 |

### 不適切なデータ型
| テーブル | カラム | 現状 | 推奨 | 理由 |
|----------|--------|------|------|------|
| `products` | `price` | FLOAT | DECIMAL(10,2) | 金額は浮動小数点を避けるべき |

## 削除ポリシー

### 現状の削除方式
| テーブル | 方式 | 実装 | 問題点 |
|----------|------|------|--------|
| `users` | 論理削除 | `deleted_at` | UNIQUE制約との競合あり |
| `logs` | 物理削除 | なし | 削除ポリシー未定義 |

### CASCADE 影響マップ
```
users (DELETE)
  ├── orders (CASCADE) -- 注文データも連鎖削除される
  │   └── order_items (CASCADE) -- 明細も連鎖削除される
  └── reviews (SET NULL) -- レビューは残りuser_id=NULLになる
```

## 改善提案（優先度順）

### 優先度: 高
1. **[テーブル名]**: [具体的な改善内容と理由]

### 優先度: 中
2. **[テーブル名]**: [具体的な改善内容と理由]

### 優先度: 低
3. **[テーブル名]**: [具体的な改善内容と理由]

## 推奨アクション
- [ ] [即座に対応すべき制約追加]
- [ ] [命名規則の統一作業]
- [ ] [削除ポリシーの策定]
```

## 安全注意

- **絶対に実際の SQL を実行しないこと** -- 本スキルはスキーマの静的レビューのみを行う
- **本番データベースへの接続を行わないこと**
- **スキーマファイルやモデル定義を変更しないこと** -- レビュー結果の報告のみ
- **正規化の改善提案は、パフォーマンスへの影響も併記すること**
- **削除ポリシーの変更は既存データへの影響を必ず警告すること**
- **GDPR / 個人情報に関連するカラムは特に注意して報告すること**
- **評価は客観的な基準に基づくこと** -- 推測による評価は「推定」と明記する

## 終了条件

- 全テーブルの命名規則が検査されていること
- 正規化水準の違反箇所が特定されていること
- 制約設計の不足箇所が報告されていること
- 削除ポリシーがテーブルごとに評価されていること
- CASCADE の影響範囲が分析されていること
- 優先度付きの改善提案が作成されていること
- 各検査軸の評価スコアが付与されていること
