---
name: ops-log-sift
description: ログファイルを解析し、仮説立案・トリアージ・次のアクション提案までを一気通貫で行う。障害対応の初動を加速する。
argument-hint: "[ログファイルパス or ログ出力のキーワード] (任意で時間範囲: --since '2h ago')"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob, Bash(git log *)
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

ログファイルやログ出力からエラーパターンを抽出し、発生頻度・影響範囲・時系列を分析する。分析結果をもとに障害の仮説を立て、トリアージの優先度を判定し、次に取るべきアクションを具体的に提案する。

## 入力

- 対象ログファイルのパス、またはログに含まれるキーワード（必須）
- 任意: 時間範囲の指定（例: 直近 2 時間、特定の日時範囲）
- 任意: 関連するサービス名やコンポーネント名
- 任意: 既知の障害情報や直近のデプロイ履歴
- 不足している場合はユーザーに質問する

## 手順

1. **ログの収集と全体把握**
   - Glob で対象ログファイルを特定する（`*.log`、`logs/`、`/var/log/` など）
   - Read でログファイルの末尾を中心に内容を読み取る
   - `git log --oneline -20` で直近のデプロイ・コミット履歴を確認する
   - ログの形式（JSON 構造化ログ / プレーンテキスト / syslog 形式）を判別する

2. **エラーパターンの抽出**
   - Grep でエラーレベルのログを抽出する（ERROR、FATAL、CRITICAL、panic、exception）
   - 同一エラーメッセージの出現頻度をカウントする
   - スタックトレースがある場合は発生元のファイル・行番号を特定する
   - 警告レベル（WARN）のログも関連性があるか確認する

3. **時系列分析**
   - エラーの初回発生時刻を特定する
   - 発生頻度の推移（増加傾向 / 間欠的 / 単発）を分析する
   - 直近のデプロイやコミットとの時間的相関を確認する
   - 関連する他のエラーやイベントとの時間的近接性を確認する

4. **仮説の立案**
   - 収集した情報をもとに、障害原因の仮説を最大 3 つ立てる
   - 各仮説に対して「裏付ける証拠」と「矛盾する点」を整理する
   - 仮説の確度を高・中・低で評価する

5. **トリアージと次のアクション**
   - 影響範囲（ユーザー数、機能範囲、データ影響）を推定する
   - 緊急度を P1（即時対応）/ P2（当日対応）/ P3（計画対応）で判定する
   - 各仮説を検証するための具体的な調査手順を提示する

## 出力フォーマット

```markdown
## ログ分析サマリ

- **対象**: [ログファイル名 / 範囲]
- **分析期間**: [開始時刻 〜 終了時刻]
- **ログ形式**: [JSON / プレーンテキスト / syslog]

## エラー分類

| # | エラーメッセージ（要約） | 発生回数 | 初回発生 | 最終発生 | 発生元 |
|---|------------------------|---------|---------|---------|--------|
| 1 | [エラー要約]            | [N 回]  | [時刻]   | [時刻]  | [ファイル:行] |

## 時系列分析

- **初回発生**: [時刻] — [直前のイベント（デプロイ等）との関連]
- **発生パターン**: [増加傾向 / 間欠的 / 単発]
- **相関イベント**: [直近のデプロイ、設定変更など]

## 仮説

| # | 仮説 | 確度 | 裏付ける証拠 | 矛盾する点 |
|---|------|------|-------------|-----------|
| 1 | [仮説内容] | 高/中/低 | [証拠] | [矛盾点] |

## トリアージ

- **緊急度**: P1 / P2 / P3
- **影響範囲**: [推定される影響]
- **推奨アクション**:
  1. [最優先で実行すべき調査・対応]
  2. [次に実行すべき調査・対応]
  3. [並行して実施可能な対応]
```

## 安全注意

- ログファイルに含まれる個人情報（メールアドレス、IP アドレス、トークン等）を出力に含めない
- 本番環境のログにアクセスする場合は読み取り専用であることを確認する
- ログファイルの変更・削除は一切行わない
- 大量のログファイル（数 GB 以上）は末尾から段階的に読み取り、一括読み込みを避ける
- 仮説はあくまで推定であり、断定的な表現を避ける

## 終了条件

上記の出力フォーマットに従ったログ分析レポートを出力したら停止する。エラー分類、時系列分析、仮説、トリアージ判定、推奨アクションが含まれていること。対応の実行はユーザーの指示を待つ。
