---
name: ci-test-matrix
description: CI のテストマトリクスを設計する。OS・ランタイムバージョン・DB の組み合わせを最適化する。
argument-hint: "[project-dir|workflow-file] (任意で対象ランタイムやDB)"
user-invocable: true
disable-model-invocation: true
allowed-tools: Read, Grep, Glob
---

あなたは慎重なシニアエンジニア。$ARGUMENTS を対象に以下を実行せよ。

## 目的

プロジェクトのサポート対象環境（OS、ランタイムバージョン、データベース等）を分析し、CI で実行すべきテストマトリクスを設計する。全組み合わせの網羅ではなく、リスクベースで重要な組み合わせを選定し、CI 実行時間とカバレッジのバランスを最適化する。

## 入力

- プロジェクトディレクトリまたはワークフローファイルのパス（必須）
- 任意: サポート対象のランタイムバージョン（例: Node 18, 20, 22）
- 任意: 使用しているデータベースやサービス（例: PostgreSQL, Redis）
- 任意: CI 実行時間の上限目標
- 不足している場合はユーザーに質問する

## 手順

1. **サポート対象環境の検出**
   - プロジェクトの設定ファイルを Glob で検索し、Read で読み取る:
     - `package.json` の `engines` フィールド
     - `pyproject.toml` の `python_requires`
     - `go.mod` の Go バージョン
     - `.node-version`、`.python-version`、`.tool-versions`
   - `docker-compose.yml`、`Dockerfile` から使用している外部サービス（DB、キャッシュ等）を検出する
   - 既存のワークフローファイルがある場合は現在のマトリクス設定を確認する

2. **互換性要件の整理**
   - 検出した情報をもとに、サポートすべきバージョン範囲を整理する:
     - **ランタイム**: LTS バージョン、現行安定版、次期バージョン（任意）
     - **OS**: Linux（必須）、macOS/Windows（クロスプラットフォーム要件に応じて）
     - **DB**: メジャーバージョン、マイナーバージョン差異のリスク評価
   - EOL（End of Life）に近いバージョンを特定し、除外または警告対象とする

3. **マトリクスの設計**
   - 全組み合わせ（直積）を算出し、総テスト数を確認する
   - リスクベースで以下の方針に従い組み合わせを選定する:
     - **必須**: 最も利用率の高いプラットフォーム + 最新 LTS
     - **推奨**: 全 LTS バージョン + 主要 OS
     - **任意**: エッジケース組み合わせ（最古サポート + 特殊 OS）
   - `include` / `exclude` ルールで非サポート組み合わせを除外する
   - `fail-fast: false` の適用判断と理由を記載する

4. **実行時間の最適化**
   - 各ジョブの推定実行時間をもとに、マトリクス全体の実行時間を見積もる
   - 以下の最適化手法を検討し、適用を提案する:
     - テストの分割実行（sharding）
     - 変更影響範囲に基づくマトリクスの動的絞り込み
     - PR 時は軽量マトリクス、main マージ時はフルマトリクスの二段構え
     - キャッシュの活用による各ジョブの高速化

5. **マトリクス YAML の生成**
   - 設計結果を GitHub Actions の `strategy.matrix` 形式で出力する
   - 各パラメータの選定理由をコメントで記述する
   - `services` ブロック（DB コンテナ等）の設定も必要に応じて含める

## 出力フォーマット

```markdown
## 検出結果

- **言語/ランタイム**: [検出された言語とバージョン制約]
- **サポート OS**: [検出またはデフォルトの OS 一覧]
- **外部サービス**: [DB、キャッシュ等のサービス一覧]
- **既存マトリクス**: [あり（現在の設定概要）/ なし]

## マトリクス設計

### 全組み合わせ

| 軸 | 値 | 選定理由 |
|----|-----|---------|
| OS | [ubuntu-latest, ...] | [理由] |
| ランタイム | [バージョン一覧] | [理由] |
| DB | [バージョン一覧] | [理由] |

### 選定結果

- **全組み合わせ数**: [直積の総数]
- **選定後の組み合わせ数**: [実行する組み合わせ数]
- **除外した組み合わせ**: [除外理由付きの一覧]
- **推定実行時間**: [並列実行時の推定所要時間]

### GitHub Actions YAML

[strategy.matrix の YAML をコードブロックで出力]

## 最適化提案

| 手法 | 効果 | 適用推奨度 |
|------|------|-----------|
| [最適化手法] | [削減時間の目安] | 高/中/低 |

## 段階的マトリクス（推奨）

- **PR 時（軽量）**: [組み合わせの概要]
- **main マージ時（フル）**: [組み合わせの概要]
- **定期実行（夜間）**: [追加で検証すべき組み合わせ]
```

## 安全注意

- ワークフローファイルの直接編集は行わず、YAML テンプレートの出力のみ行う
- EOL バージョンのサポート継続はセキュリティリスクとして警告する
- マトリクスの組み合わせ爆発（50件超）が発生する場合は明確に警告し、削減案を提示する
- DB サービスのパスワードやポート設定にはデフォルト値またはシークレット参照を使用する
- 本番環境の情報（接続先、認証情報）をマトリクス設定に含めない

## 終了条件

上記の出力フォーマットに従ったマトリクス設計書を出力したら停止する。選定理由付きの組み合わせ一覧、YAML テンプレート、最適化提案が含まれていること。ワークフローへの適用はユーザーの指示を待つ。
