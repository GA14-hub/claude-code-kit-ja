#!/usr/bin/env bash
# =============================================================================
# commit-msg hook: Conventional Commits フォーマットチェック
# =============================================================================
# 設計原則:
#   - opt-in: デフォルト無効（手動でインストールが必要）
#   - ネットワークアクセスなし
#   - 短く監査しやすいスクリプト
#   - 非準拠の場合も警告のみ（ブロックしない）
#
# 無効化: SKIP_HOOKS=1 git commit -m "message"
# 個別無効化: SKIP_COMMIT_MSG=1 git commit -m "message"
# =============================================================================

set -euo pipefail

# --- バイパス ---
if [ "${SKIP_HOOKS:-0}" = "1" ] || [ "${SKIP_COMMIT_MSG:-0}" = "1" ]; then
  exit 0
fi

# --- コミットメッセージの取得 ---
COMMIT_MSG_FILE="$1"
if [ ! -f "$COMMIT_MSG_FILE" ]; then
  exit 0
fi

# コメント行と空行を除いた最初の行を取得
FIRST_LINE=$(grep -v '^#' "$COMMIT_MSG_FILE" | grep -v '^$' | head -1 || true)

if [ -z "$FIRST_LINE" ]; then
  exit 0
fi

# --- Conventional Commits パターン ---
# 形式: type(scope)?: description
# type: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert
PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{1,}'

if ! echo "$FIRST_LINE" | grep -Eq "$PATTERN"; then
  echo ""
  echo "========================================================================"
  echo "[commit-msg] Conventional Commits 形式ではありません（警告）"
  echo "========================================================================"
  echo ""
  echo "  現在のメッセージ: $FIRST_LINE"
  echo ""
  echo "  推奨形式: <type>(<scope>): <description>"
  echo ""
  echo "  type の一覧:"
  echo "    feat     : 新機能"
  echo "    fix      : バグ修正"
  echo "    docs     : ドキュメントのみの変更"
  echo "    style    : コードの意味に影響しない変更（空白、フォーマット等）"
  echo "    refactor : バグ修正でも機能追加でもないコード変更"
  echo "    perf     : パフォーマンス改善"
  echo "    test     : テストの追加・修正"
  echo "    build    : ビルドシステムや外部依存の変更"
  echo "    ci       : CI 設定の変更"
  echo "    chore    : その他の変更"
  echo "    revert   : コミットの取り消し"
  echo ""
  echo "  例:"
  echo "    feat(auth): ログイン機能を追加"
  echo "    fix: ヌルポインタ例外を修正"
  echo "    docs(readme): インストール手順を更新"
  echo ""
  echo "  このメッセージは警告です。コミットはブロックされません。"
  echo "========================================================================"
  echo ""
fi

# --- 文字数チェック（警告のみ） ---
FIRST_LINE_LENGTH=${#FIRST_LINE}
if [ "$FIRST_LINE_LENGTH" -gt 72 ]; then
  echo "[commit-msg] 1 行目が 72 文字を超えています（${FIRST_LINE_LENGTH} 文字）。短くすることを推奨します。"
fi

# 常に成功終了（ブロックしない）
exit 0
